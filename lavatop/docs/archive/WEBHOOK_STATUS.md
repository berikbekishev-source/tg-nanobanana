# ‚úÖ –°—Ç–∞—Ç—É—Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–µ–º–∞ –≤–µ–±—Ö—É–∫–æ–≤ Lava.top

## üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

### ‚úÖ –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:

1. **–û–±–Ω–æ–≤–ª–µ–Ω –ø–∞—Ä—Å–µ—Ä –≤–µ–±—Ö—É–∫–æ–≤** (`lavatop/webhook.py`):
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ Lava.top
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —Å–æ–±—ã—Ç–∏–π (`eventType`)
   - –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ `product` –∏ `buyer`
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–æ–¥–ø–∏—Å–æ–∫ –∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π

2. **–û–±–Ω–æ–≤–ª–µ–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ API** (`lavatop/api.py`):
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Å–æ–±—ã—Ç–∏–π
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∞–∂–Ω—ã—Ö –ø–æ–ª–µ–π
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤: `completed`, `failed`, `subscription-active`, `subscription-failed`

3. **–°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç** (`lavatop/tests/test_official_webhook.py`):
   - –í—Å–µ —Ç–∏–ø—ã –≤–µ–±—Ö—É–∫–æ–≤ —Å–æ–≥–ª–∞—Å–Ω–æ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏
   - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω—ã—Ö –∏ –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π
   - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–æ–∫

## üìã –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤–µ–±—Ö—É–∫–∞ –æ—Ç Lava.top:

```json
{
  "eventType": "payment.success",
  "product": {
    "id": "d31384b8-e412-4be5-a2ec-297ae6666c8f",
    "title": "100 –¢–æ–∫–µ–Ω–æ–≤"
  },
  "buyer": {
    "email": "test@example.com"
  },
  "contractId": "7ea82675-4ded-4133-95a7-a6efbaf165cc",
  "amount": 5.00,
  "currency": "USD",
  "timestamp": "2024-10-25T09:38:27.33277Z",
  "status": "completed",
  "errorMessage": ""
}
```

## üîÑ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ç–∏–ø—ã —Å–æ–±—ã—Ç–∏–π:

| Event Type | Status | –û–ø–∏—Å–∞–Ω–∏–µ |
|------------|--------|----------|
| `payment.success` | `completed` | –£—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞ –ø—Ä–æ–¥—É–∫—Ç–∞ |
| `payment.failed` | `failed` | –ù–µ—É–¥–∞—á–Ω–∞—è –æ–ø–ª–∞—Ç–∞ –ø—Ä–æ–¥—É–∫—Ç–∞ |
| `payment.success` | `subscription-active` | –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ (–ø–µ—Ä–≤—ã–π –ø–ª–∞—Ç–µ–∂) |
| `subscription.recurring.payment.success` | `subscription-active` | –£—Å–ø–µ—à–Ω–æ–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ |
| `subscription.recurring.payment.failed` | `subscription-failed` | –ù–µ—É–¥–∞—á–Ω–æ–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ |
| `subscription.cancelled` | - | –û—Ç–º–µ–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∏ |

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∏:

### Railway –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:
```bash
LAVA_API_KEY=HUavlwH154yV1KjiTbEKnZJyHxem7W0SgE7iIKsbq6MlSjNMulkOS3GgYEadREEb
LAVA_WEBHOOK_SECRET=lava_webhook_secret_ABC123xyz789
```

### Webhook URL:
```
https://web-production-96df.up.railway.app/api/miniapp/lava-webhook
```

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏:

### 1. –¢–µ—Å—Ç–æ–≤—ã–π –≤–µ–±—Ö—É–∫ (—Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç - —Ä–∞–±–æ—Ç–∞–µ—Ç):
```bash
python3 lavatop/tests/send_test_webhook_now.py
# –†–µ–∑—É–ª—å—Ç–∞—Ç: 200 OK
```

### 2. –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç (—Ç—Ä–µ–±—É–µ—Ç –æ—Ç–ª–∞–¥–∫–∏):
```bash
python3 lavatop/tests/test_official_webhook.py success
# –¢–µ–∫—É—â–∞—è –ø—Ä–æ–±–ª–µ–º–∞: contractId –Ω–µ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –≤ order_id
```

## ‚ö†Ô∏è –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

1. **Mapping contractId ‚Üí order_id:**
   - –í –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `contractId`
   - –í –Ω–∞—à–µ–π –ë–î —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –∏—â–µ—Ç—Å—è –ø–æ `id`
   - –¢—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –º–∞–ø–ø–∏–Ω–≥–∞

2. **–í–∞–ª—é—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:**
   - Lava.top –∏—Å–ø–æ–ª—å–∑—É–µ—Ç RUB –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
   - –ù–∞—à–∞ —Å–∏—Å—Ç–µ–º–∞ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–∞ –Ω–∞ USD
   - –¢—Ä–µ–±—É–µ—Ç—Å—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∫—É—Ä—Å–∞

## üöÄ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –ø–æ–ª–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:

1. **–í –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ Lava.top:**
   - –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–¥—É–∫—Ç "100 –¢–æ–∫–µ–Ω–æ–≤" –∑–∞ $5 (–∏–ª–∏ —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç –≤ RUB)
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å webhook URL
   - –í–∫–ª—é—á–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

2. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ –∫–∞–±–∏–Ω–µ—Ç:**
   - –ù–∞–π—Ç–∏ –∫–Ω–æ–ø–∫—É "Test Webhook" –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö
   - –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –≤–µ–±—Ö—É–∫
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏: `railway logs --service web`

3. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:**
   - –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `contract_id` –≤ –º–æ–¥–µ–ª—å Transaction
   - –°–æ—Ö—Ä–∞–Ω—è—Ç—å `contractId` –æ—Ç Lava.top –¥–ª—è —Å–≤—è–∑–∏

## üìù –ü—Ä–æ–≤–µ—Ä–æ—á–Ω—ã–π —á–µ–∫-–ª–∏—Å—Ç:

- [x] –ü–∞—Ä—Å–µ—Ä –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
- [x] API –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª–µ–π
- [x] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –≤–∞–∂–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
- [x] –¢–µ—Å—Ç–æ–≤—ã–µ —Å–∫—Ä–∏–ø—Ç—ã —Å–æ–∑–¥–∞–Ω—ã
- [ ] –ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –≤–µ–±—Ö—É–∫–∞–º–∏ Lava.top
- [ ] –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–¥–ø–∏—Å–æ–∫
- [ ] –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤–∞–ª—é—Ç RUB ‚Üî USD

## üéØ –í—ã–≤–æ–¥:

–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –ø—Ä–∏–µ–º—É –≤–µ–±—Ö—É–∫–æ–≤ –æ—Ç Lava.top –≤ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ. –¢—Ä–µ–±—É–µ—Ç—Å—è:
1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ Lava.top
2. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü–∏—é "Test Webhook" –≤ –∫–∞–±–∏–Ω–µ—Ç–µ
3. –ù–µ–±–æ–ª—å—à–∞—è –¥–æ—Ä–∞–±–æ—Ç–∫–∞ –º–∞–ø–ø–∏–Ω–≥–∞ `contractId` ‚Üí —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –≤ –ë–î