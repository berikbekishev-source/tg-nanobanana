# –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ WebApp –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç)

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç ‚Äî **–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ –≤–µ—Ä–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ** –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é WebApp-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤ –¥–ª—è AI-–º–æ–¥–µ–ª–µ–π (Midjourney, Kling, Nano Banana –∏ –¥—Ä.) –≤ –ø—Ä–æ–µ–∫—Ç–µ NanoBanana.

## üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û–ï –¢–ï–•–ù–ò–ß–ï–°–ö–û–ï –û–ì–†–ê–ù–ò–ß–ï–ù–ò–ï

–í –Ω–∞—à–µ–º –±–æ—Ç–µ WebApp –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ **Inline-–∫–Ω–æ–ø–∫–∏** (–∫–Ω–æ–ø–∫–∏ –ø–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏–µ–º).

> **–°–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ Telegram Bot API:**
> –ú–µ—Ç–æ–¥ `Telegram.WebApp.sendData()` **–ù–ï –†–ê–ë–û–¢–ê–ï–¢** –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ WebApp –∏–∑ Inline-–∫–Ω–æ–ø–∫–∏. –î–∞–Ω–Ω—ã–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è, `web_app_data` –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä.

### ‚úÖ –ï–î–ò–ù–°–¢–í–ï–ù–ù–û–ï –†–ê–ë–û–ß–ï–ï –†–ï–®–ï–ù–ò–ï:
–ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º **REST API** –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å WebApp –Ω–∞ —Å–µ—Ä–≤–µ—Ä.
1.  WebApp —Å–æ–±–∏—Ä–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ.
2.  JS –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `POST` –∑–∞–ø—Ä–æ—Å –Ω–∞–ø—Ä—è–º—É—é –Ω–∞ –Ω–∞—à Backend (`/api/...`).
3.  JS –≤—ã–∑—ã–≤–∞–µ—Ç `tg.close()` –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –æ–∫–Ω–∞.

---

## 1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–æ—Ç–æ–∫–∞ –¥–∞–Ω–Ω—ã—Ö

1.  **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å** –Ω–∞–∂–∏–º–∞–µ—Ç Inline-–∫–Ω–æ–ø–∫—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, "Midjourney").
2.  –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è **WebApp** (HTML/JS).
3.  –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å".
4.  **JS** –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `POST` –∑–∞–ø—Ä–æ—Å –Ω–∞ `/api/<model>/webapp/submit`.
5.  **Backend (API View)** –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–∞–ø—Ä–æ—Å, –Ω–∞—Ö–æ–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –ª–æ–≥–∏–∫—É –±–æ—Ç–∞.
6.  **JS** –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –æ–∫–Ω–æ WebApp.
7.  **–ë–æ—Ç** –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–æ–æ–±—â–µ–Ω–∏–µ "üé® –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–∞—á–∞–ª–∞—Å—å!".

---

## 2. Frontend: JS –ü–∞—Ç—Ç–µ—Ä–Ω (Copy-Paste)

–í —Ñ–∞–π–ª–µ `webapps/<model>/index.html` –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ **—Ä–æ–≤–Ω–æ —ç—Ç–æ—Ç –∫–æ–¥** –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –ù–µ –ø—ã—Ç–∞–π—Ç–µ—Å—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `sendData` –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ payload!

```javascript
// –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏
function sendData() {
    // 1. –í–∞–ª–∏–¥–∞—Ü–∏—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —á–µ—Ä–µ–∑ tg.showAlert)
    if (!state.prompt) {
        tg.showAlert("–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º—Ç");
        return;
    }

    // 2. –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö
    const payload = {
        kind: "<model>_settings", // –ù–∞–ø—Ä–∏–º–µ—Ä: kling_settings
        prompt: state.prompt,
        // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è ...
    };

    const userId = tg.initDataUnsafe?.user?.id;
    
    if (!userId) {
        tg.showAlert("–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram.");
        return;
    }

    // 3. –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ REST API (–û—Å–Ω–æ–≤–Ω–æ–π –∫–∞–Ω–∞–ª)
    tg.MainButton.showProgress(); // –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏–Ω–Ω–µ—Ä –Ω–∞ –∫–Ω–æ–ø–∫–µ
    
    fetch('/api/<model>/webapp/submit', {
        method: 'POST',
        headers: { 
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken') // –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Django CSRF
        },
        body: JSON.stringify({ 
            user_id: userId, 
            data: payload,
            initData: tg.initData // –î–ª—è –±—É–¥—É—â–µ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏
        })
    })
    .then(response => {
        if (response.ok) {
            // –£—Å–ø–µ—Ö -> –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ
            tg.close();
        } else {
            tg.MainButton.hideProgress();
            tg.showAlert("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
            console.error("Server Error:", response);
        }
    })
    .catch(error => {
        tg.MainButton.hideProgress();
        tg.showAlert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: " + error.message);
        console.error("Network Error:", error);
    });
}
```

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ UI (UX)
1.  **–ö–Ω–æ–ø–∫–∞ "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å":**
    *   –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ **–¢–û–õ–¨–ö–û** `tg.MainButton` (—Å–∏–Ω—è—è –∫–Ω–æ–ø–∫–∞ –≤–Ω–∏–∑—É).
    *   –°–∫—Ä—ã–≤–∞–π—Ç–µ –µ—ë (`.hide()`), –ø–æ–∫–∞ –ø–æ–ª–µ –ø—Ä–æ–º—Ç–∞ –ø—É—Å—Ç–æ–µ.
    *   –ü–æ–∫–∞–∑—ã–≤–∞–π—Ç–µ (`.show()`), –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—á–∞–ª –≤–≤–æ–¥.
2.  **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:** –í—Å–µ –æ—à–∏–±–∫–∏ (–≤–∞–ª–∏–¥–∞—Ü–∏—è, —Å–µ—Ç—å) –ø–æ–∫–∞–∑—ã–≤–∞–π—Ç–µ —á–µ—Ä–µ–∑ `tg.showAlert()`.

---

## 3. Backend: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è (Python/Django)

–í–∞–º –Ω—É–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –¥–≤–µ —Ç–æ—á–∫–∏ –≤—Ö–æ–¥–∞.

### 3.1. REST Endpoint (`botapp/api.py`)

–î–æ–±–∞–≤—å—Ç–µ endpoint, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏–º–µ—Ç JSON –∏ –∑–∞–ø—É—Å—Ç–∏—Ç –ª–æ–≥–∏–∫—É.

```python
@api.post("/<model>/webapp/submit")
async def <model>_webapp_submit(request):
    """–ü—Ä–∏–Ω–∏–º–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ—Ç WebApp –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏—é."""
    try:
        body = json.loads(request.body.decode("utf-8"))
        user_id = body.get("user_id")
        data = body.get("data") # –í–∞—à payload

        if not user_id or not data:
            return JsonResponse({"ok": False, "error": "Invalid data"}, status=400)

        # –≠–º—É–ª—è—Ü–∏—è Update –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –ª–æ–≥–∏–∫–∏ —Ö–µ–Ω–¥–ª–µ—Ä–æ–≤
        # –ò–õ–ò –ø—Ä—è–º–æ–π –≤—ã–∑–æ–≤ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ (–ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–µ–µ –¥–ª—è —á–∏—Å—Ç–æ—Ç—ã)
        
        # –í–∞—Ä–∏–∞–Ω—Ç: –ü—Ä—è–º–æ–π –≤—ã–∑–æ–≤ —Ö–µ–Ω–¥–ª–µ—Ä–∞ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
        # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –≤–∞—à—É —Ñ—É–Ω–∫—Ü–∏—é –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑ handlers/...
        from botapp.handlers.<model>_generation import process_webapp_data
        
        # –ó–∞–ø—É—Å–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ —Ñ–æ–Ω–µ –∏–ª–∏ await (–µ—Å–ª–∏ –±—ã—Å—Ç—Ä–æ)
        await process_webapp_data(user_id, data)

        return JsonResponse({"ok": True})
    except Exception as e:
        logger.error(f"WebApp Submit Error: {e}", exc_info=True)
        return JsonResponse({"ok": False, "error": str(e)}, status=500)
```

### 3.2. Logic Handler (`botapp/handlers/<model>_generation.py`)

–í—ã–¥–µ–ª–∏—Ç–µ –ª–æ–≥–∏–∫—É –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é `async` —Ñ—É–Ω–∫—Ü–∏—é, –∫–æ—Ç–æ—Ä—É—é –º–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å –∏ –∏–∑ API, –∏ –∏–∑ –±–æ—Ç–∞ (–¥–ª—è —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ—Å—Ç–∏).

```python
async def process_webapp_data(user_id: int, payload: dict):
    """
    –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞: –≤–∞–ª–∏–¥–∞—Ü–∏—è, –±–∞–ª–∞–Ω—Å, –∑–∞–ø—É—Å–∫ –∑–∞–¥–∞—á–∏.
    """
    user = await sync_to_async(TgUser.objects.get)(chat_id=user_id)
    
    # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞
    balance_service = BalanceService()
    can_gen, msg = await sync_to_async(balance_service.check_can_generate)(user, model...)
    if not can_gen:
        await bot.send_message(user_id, f"‚ùå {msg}")
        return

    # 2. –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ (GenRequest)
    # ...
    
    # 3. –ó–∞–ø—É—Å–∫ Celery Task
    # ...
    
    # 4. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    await bot.send_message(user_id, "üé® –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–∞—á–∞–ª–∞—Å—å!")
```

---

## 4. –ß–µ–∫-–ª–∏—Å—Ç –¥–ª—è –ê–≥–µ–Ω—Ç–∞ (Self-Check)

–ü–µ—Ä–µ–¥ —Å–¥–∞—á–µ–π —Ä–∞–±–æ—Ç—ã –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

1.  [ ] **–û—Ç–∫—Ä—ã—Ç–∏–µ:** WebApp –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ –∫–Ω–æ–ø–∫–µ?
2.  [ ] **UI:** –ö–Ω–æ–ø–∫–∞ `MainButton` —Å–∫—Ä—ã—Ç–∞ –ø—Ä–∏ –ø—É—Å—Ç–æ–º –ø—Ä–æ–º—Ç–µ?
3.  [ ] **–û—Ç–ø—Ä–∞–≤–∫–∞:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `fetch` –Ω–∞ `/api/.../submit`? (–ù–µ –Ω–∞–¥–µ–π—Ç–µ—Å—å –Ω–∞ `sendData`!)
4.  [ ] **Backend:** Endpoint –≤ `api.py` —Å–æ–∑–¥–∞–Ω –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω?
5.  [ ] **–õ–æ–≥–∏–∫–∞:** –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è, —Å–æ–æ–±—â–µ–Ω–∏–µ "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–∞—á–∞–ª–∞—Å—å" –ø—Ä–∏—Ö–æ–¥–∏—Ç?

---
**–°–ª–µ–¥—É–π—Ç–µ —ç—Ç–æ–º—É —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É, –∏ –≤–∞—à WebApp –∑–∞—Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ø–µ—Ä–≤–æ–≥–æ —Ä–∞–∑–∞.**
