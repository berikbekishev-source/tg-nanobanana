# Инструкция для ИИ-агентов

Документ описывает правила работы с проектом, его структуру и доступные инструменты. Действуйте строго в рамках указанных процессов и не нарушайте приведённые ограничения.

## Структура проекта

- `botapp/` — основная бизнес-логика бота: модели (`models.py`), API на Django Ninja (`api.py`), Celery-задачи (`tasks.py`), обработчики Telegram (`handlers/`, `telegram.py`), интеграции (`providers/`, `services.py`), вспомогательные модули (`business/`).
- `config/` — конфигурация Django: основные настройки (`settings.py`), ASGI (`asgi.py`), Celery (`celery.py`), URL-маршруты (`urls.py`), упрощённые настройки для тестов (`settings_sqlite.py`).
- `manage.py` — стандартная точка входа Django.
- `Dockerfile.web`, `Dockerfile.worker`, `docker-compose.yml` — контейнеризация и локальный запуск web/worker/beat/flower/redis.
- `requirements.txt` — список Python-зависимостей.
- `Документация/` — все внутренние документы проекта (добавляйте новые инструкции сюда).

## Рабочее окружение

- Основной стек: Python 3.12 (локально), Django 5.2, Celery, Redis, PostgreSQL (Supabase), Railway.
- Все чувствительные значения берите из переменных окружения Railway либо `.env.railway`. Не храните секреты в других местах.

## Доступные инструменты

### 1. База данных Supabase

- **PostgreSQL-подключение** (используйте для `psql`, миграций, SQL-скриптов):
  ```
  postgresql://postgres.eqgcrggbksouurhjxvzs:3ZVyk8a27nT4lHMh@aws-1-eu-north-1.pooler.supabase.com:5432/postgres
  ```
- **REST и Storage API**:
  - `SUPABASE_URL`: `https://eqgcrggbksouurhjxvzs.supabase.co`
  - `SUPABASE_SERVICE_ROLE_KEY`: `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVxZ2NyZ2dia3NvdXVyaGp4dnpzIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NTUxNDc5OSwiZXhwIjoyMDcxMDkwNzk5fQ.MPnkmxqucGWASbifVoBN80d4k_fIGeo0XTWWdNf1AU0`
  - `SUPABASE_BUCKET`: `video_veo3`
  - Для Storage Video используйте `SUPABASE_VIDEO_BUCKET` (если указан отдельно).
- **CLI**:
  1. Установите [Supabase CLI](https://supabase.com/docs/reference/cli/installation).
  2. Выполните `supabase login --token <SUPABASE_SERVICE_ROLE_KEY>`.
  3. Для прямого подключения к БД: `supabase db remote connect --db-url "<DATABASE_URL>"`.
- **REST запросы**: добавляйте заголовок `apikey: <SUPABASE_SERVICE_ROLE_KEY>` и `Authorization: Bearer <SUPABASE_SERVICE_ROLE_KEY>`.

### 2. Railway

- Используется для деплоя web, worker, beat, flower и Redis.
- Основные команды Railway CLI (проект и окружение уже привязаны):
  - `railway status` — текущий сервис, состояние деплоя, домены.
  - `railway logs --service web --lines 100` — последние логи web-сервиса (аналогично для `worker`, `beat`, `flower`).
  - `railway variables --service <service>` — просмотр переменных окружения.
- **Деплой**:
  - Деплой производится **только через GitHub**: коммит → `git push origin main` → Railway автоматически строит и выкатывает все сервисы.
  - Ручные загрузки (`railway up`, `railway deploy`, любые команды, меняющие код минуя GitHub) **запрещены**. Railway CLI используем лишь для диагностики (status/logs/variables).
- **Миграции**:
  - Перед пушем убедитесь, что необходимые миграции присутствуют в `botapp/migrations/`.
  - На Railway веб-сервис стартует командой, в которой автоматически выполняется `python manage.py migrate` перед запуском Gunicorn.

### 3. GitHub репозиторий

- Репозиторий: `https://github.com/berikbekishev-source/tg-nanobanana`.
- Рабочая ветка по умолчанию — `main`.
- Любое значимое изменение (код, миграции, конфигурация) обязательно оформляется коммитом.
- После завершения задачи:
  1. Проверьте, что тесты/линтеры (если есть) пройдены.
  2. Сделайте коммит с осмысленным сообщением.
  3. Выполните `git push origin main`.
- Только после пуша на GitHub произойдёт продакшн-деплой на Railway. Не обходите этот процесс.

## Общие рекомендации

- Перед редактированием файлов убедитесь, что локальная ветка синхронизирована с `origin/main`.
- Не удаляйте и не меняйте чужие секреты и переменные без согласования.
- Фиксируйте в документации процессы, которые могут понадобиться другим агентам.
- Проверяйте логи Railway и Supabase при любом инциденте (ошибки миграций, Celery, внешние API).

Следуйте инструкции, чтобы поддерживать стабильность сервиса и прозрачность процессов развёртывания.
