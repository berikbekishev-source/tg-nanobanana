# План очистки БД (агент по данным)

Цель: выявить неиспользуемые данные/поля, зафиксировать риски миграций и предложить безопасные шаги. Исполнять миграции, меняющие схему, только после согласования.

## Наблюдения
- Основные модели в `botapp/models.py` активны (TgUser, UserBalance, AIModel, GenRequest, Transaction, UserSettings, Promocode, PricingSettings, TokenPackage [managed=False], ChatThread/ChatMessage, BotErrorEvent).
- Миграции `0027`–`0028` содержат PostgreSQL-специфичный SQL (триггеры/DO $$), падают на sqlite — локальные тесты нужно гонять через postgres или учитывать это.
- Поля `UserSettings` без runtime-использования (только админка): `notifications_enabled`, `notify_on_completion`, `notify_on_bonus`, `notify_on_news`, `interface_language`, `default_image_quantity`, `default_video_duration`, `preferred_image_model`, `preferred_video_model`, `achievements`. Остальные поля используют бизнес-слой (daily_reward_streak, experience_points, totals).
- `UserBalance.referral_code/referred_by` заполняются, но нет связки с реальным поиском по коду (реферальный бонус вызывается напрямую, без кода); поле может быть лишним либо требовать реализации механики ввода кода.
- `GenRequest.model` заполняется для обратной совместимости, но не читается в текущем коде; реальный выбор модели идёт через `ai_model` и `generation_params`.
- `TokenPackage` — managed=False, опирается на внешнюю таблицу `token_packages` в Railway/Postgres; в локальных sqlite-сборках таблицы нет.

## Рекомендуемые шаги (без деструктивных применений)
1) Подготовить миграцию для удаления неиспользуемых полей `UserSettings` (перечень выше) + чистка `admin.py`/форм. Перед применением — подтвердить, что эти флаги не нужны в ближайших задачах.
2) Определиться с реферальной механикой:
   - либо реализовать поиск/привязку по `referral_code`, 
   - либо запланировать миграцию на удаление `referral_code` и `referred_by` (если не нужны).
3) Депрекейт `GenRequest.model`: добавить комментарий/issue, затем отдельной миграцией убрать поле после подтверждения; данные для обратной совместимости можно сохранить в `provider_metadata`.
4) Зафиксировать, что миграции `0027`–`0028` требуют Postgres; для sqlite-чатов/демо — использовать `config.settings_sqlite` с `--check` или мокать эти миграции.
5) Проверить наличие таблицы `token_packages` в Railway (production/staging); при отсутствии — или создать вручную, или отключить обращения в `lavatop`.

## Проверки
- Статический анализ (`rg`) для поиска использования полей — выполнен.
- Запуск миграций **не выполнялся** (деструктивные изменения не применялись).

## Следующие действия (предложение)
- Согласовать с владельцем продукта пункты 1–3, затем подготовить миграции и очистку админок.
- Отдельно — ревизия индексов после удаления полей (если будут миграции).
