name: Staging Ops GC (TTL)

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  gc:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: staging
          fetch-depth: 0
      - name: Auto-release if TTL expired
        shell: bash
        run: |
          set -euo pipefail
          # read current block
          block=$(awk '/^## Сейчас/{flag=1;print;next}/^## /{flag=0}flag' STAGING_STATUS.md)
          status=$(echo "$block" | awk -F': ' '/^- Статус:/ {print $2}')
          [[ "$status" != "Занят" ]] && {
            echo "staging is free, nothing to do"; exit 0; }
          eta=$(echo "$block" | awk -F': ' '/^- ETA:/ {print $2}') || true
          if [[ -z "$eta" ]]; then echo "No ETA set, skipping"; exit 0; fi
          now_epoch=$(date -u +%s)
          eta_epoch=$(date -u -d "$eta" +%s || echo 0)
          if (( now_epoch <= eta_epoch )); then echo "Not expired yet"; exit 0; fi
          # expire and free
          now_utc=$(date -u +"%Y-%m-%d %H:%M UTC")
          tmp=$(mktemp)
          awk -v now="$now_utc" '
            BEGIN{RS=""; ORS="\n\n"}
            /^# Статус стенда staging/ {
              n=split($0, a, /\n\n/);
              for (i=1;i<=n;i++){
                if (a[i] ~ /^## Сейчас/){
                  a[i] = "## Сейчас\n- Статус: Свободен\n- Агент: bot/auto-GC\n- PR / коммит: n/a\n- Обновлено: " now "\n- Комментарий: авто-освобождение по TTL";
                }
              }
              for (i=1;i<=n;i++) print a[i];
              next
            }
            {print}
          ' STAGING_STATUS.md > "$tmp"
          mv "$tmp" STAGING_STATUS.md
          git add STAGING_STATUS.md
          git -c user.name="staging-bot" -c user.email="staging-bot@users.noreply.github.com" commit -m "chore(staging): авто-освобождение по TTL"
          git push origin HEAD:staging

