name: Staging Ops (ChatOps)

on:
  issue_comment:
    types: [created]
  repository_dispatch:
    types: [reserve-staging, deploy-staging, release-staging]

permissions:
  contents: write
  pull-requests: write
  issues: write
  statuses: write

env:
  RAILWAY_GRAPHQL: https://backboard.railway.app/graphql/v2
  RAILWAY_PROJECT_ID: 866bc61a-0ef1-41d1-af53-26784f6e5f06
  STAGING_ENV_ID: 9e15b55d-8220-4067-a47e-191a57c2bcca
  STAGING_BASE_URL: https://web-staging-70d1.up.railway.app

jobs:
  parse:
    name: Parse ChatOps Command
    runs-on: ubuntu-latest
    outputs:
      cmd: ${{ steps.parse.outputs.cmd }}
      ttl: ${{ steps.parse.outputs.ttl }}
      reason: ${{ steps.parse.outputs.reason }}
      pr: ${{ steps.parse.outputs.pr }}
      actor: ${{ steps.parse.outputs.actor }}
    steps:
      - name: Check PR context and parse
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            // Support two entrypoints: issue_comment and repository_dispatch
            if (context.eventName === 'repository_dispatch') {
              const action = context.payload?.action || '';
              const payload = context.payload?.client_payload || {};
              core.setOutput('cmd', action.replace('-staging',''));
              core.setOutput('ttl', payload.ttl || '15m');
              core.setOutput('reason', payload.reason || '');
              core.setOutput('pr', String(payload.pr || ''));
              core.setOutput('actor', payload.actor || context.actor);
              return;
            }
            const body = (context.payload.comment?.body || '').trim();
            const isPR = !!context.payload.issue?.pull_request;
            if (!isPR) return core.setOutput('cmd', '');
            const pr = context.payload.issue.number;
            const actor = context.actor;
            function getArg(s, key) {
              const m = s.match(new RegExp(`${key}:(.+)$`));
              return m ? m[1].trim() : '';
            }
            if (/^\/reserve-staging\b/i.test(body)) {
              // format: /reserve-staging 15m reason: —Ç–µ–∫—Å—Ç
              const ttlMatch = body.match(/^\/reserve-staging\s+(\d+)(m|h)?/i);
              let ttl = '15m';
              if (ttlMatch) ttl = `${ttlMatch[1]}${ttlMatch[2] || 'm'}`;
              const reason = getArg(body, 'reason');
              core.setOutput('cmd', 'reserve');
              core.setOutput('ttl', ttl);
              core.setOutput('reason', reason);
            } else if (/^\/deploy-staging\b/i.test(body)) {
              core.setOutput('cmd', 'deploy');
            } else if (/^\/release-staging\b/i.test(body)) {
              core.setOutput('cmd', 'release');
            } else {
              core.setOutput('cmd', '');
            }
            core.setOutput('pr', String(pr));
            core.setOutput('actor', actor);

  reserve:
    name: Reserve staging
    needs: parse
    if: needs.parse.outputs.cmd == 'reserve'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout staging
        uses: actions/checkout@v4
        with:
          ref: staging
          fetch-depth: 0

      - name: Compute TTL and timestamps
        id: ts
        shell: bash
        run: |
          set -euo pipefail
          ttl="${{ needs.parse.outputs.ttl }}"
          # parse ttl like 15m or 1h
          if [[ "$ttl" =~ ^([0-9]+)h$ ]]; then mins=$((BASH_REMATCH[1]*60));
          elif [[ "$ttl" =~ ^([0-9]+)m$ ]]; then mins=${BASH_REMATCH[1]};
          else mins=15; fi
          now_utc=$(date -u +"%Y-%m-%d %H:%M UTC")
          exp_epoch=$(date -u -d "+${mins} minutes" +%s)
          exp_human=$(date -u -d "@${exp_epoch}" +"%Y-%m-%d %H:%M UTC")
          echo "mins=$mins" >> $GITHUB_OUTPUT
          echo "now_utc=$now_utc" >> $GITHUB_OUTPUT
          echo "exp_human=$exp_human" >> $GITHUB_OUTPUT

      - name: Update STAGING_STATUS.md (–ó–∞–Ω—è—Ç)
        shell: bash
        env:
          AGENT: ${{ needs.parse.outputs.actor }}
          PR_NUMBER: ${{ needs.parse.outputs.pr }}
          NOW: ${{ steps.ts.outputs.now_utc }}
          ETA: ${{ steps.ts.outputs.exp_human }}
          REASON: ${{ needs.parse.outputs.reason }}
        run: |
          set -euo pipefail
          sha7=$(git rev-parse --short HEAD || echo none)
          tmp=$(mktemp)
          awk -v agent="$AGENT" -v pr="PR #$PR_NUMBER, $sha7" -v now="$NOW" -v eta="$ETA" -v reason="$REASON" '
            BEGIN{RS=""; ORS="\n\n"}
            /^# –°—Ç–∞—Ç—É—Å —Å—Ç–µ–Ω–¥–∞ staging/ {
              # split paragraphs, replace the block starting with "## –°–µ–π—á–∞—Å"
              n=split($0, a, /\n\n/);
              for (i=1;i<=n;i++){
                if (a[i] ~ /^## –°–µ–π—á–∞—Å/){
                  a[i] = "## –°–µ–π—á–∞—Å\n- –°—Ç–∞—Ç—É—Å: –ó–∞–Ω—è—Ç\n- –ê–≥–µ–Ω—Ç: " agent "\n- PR / –∫–æ–º–º–∏—Ç: " pr "\n- –û–±–Ω–æ–≤–ª–µ–Ω–æ: " now "\n- ETA: " eta "\n- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: " reason;
                }
              }
              for (i=1;i<=n;i++) print a[i];
              next
            }
            {print}
          ' STAGING_STATUS.md > "$tmp"
          mv "$tmp" STAGING_STATUS.md
          git add STAGING_STATUS.md
          git -c user.name="staging-bot" -c user.email="staging-bot@users.noreply.github.com" commit -m "chore(staging): –∑–∞–Ω—è–ª —Å—Ç–µ–Ω–¥ (PR #$PR_NUMBER)"

      - name: Push to staging
        env:
          PUSH_TOKEN: ${{ secrets.ADMIN_GH_TOKEN || github.token }}
        run: |
          set -euo pipefail
          git config --global http.https://github.com/.extraheader ""
          git remote set-url origin https://x-access-token:${PUSH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git
          git push origin HEAD:staging

      - name: Set STAGING_BUSY status
        uses: actions/github-script@v7
        with:
          script: |
            const { data: branch } = await github.repos.getBranch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              branch: 'staging'
            });
            await github.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: branch.commit.sha,
              state: 'success',
              context: 'STAGING_BUSY',
              description: 'staging –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω',
              target_url: `${process.env["GITHUB_SERVER_URL"] || 'https://github.com'}/${context.repo.owner}/${context.repo.repo}/tree/staging`
            });

      - name: Comment back
        uses: actions/github-script@v7
        with:
          script: |
            await github.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: Number('${{ needs.parse.outputs.pr }}'),
              body: `‚úÖ –°—Ç–µ–Ω–¥ –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω –Ω–∞ ${{ steps.ts.outputs.mins }} –º–∏–Ω. –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: "${{ needs.parse.outputs.reason }}".`
            });

  deploy:
    name: Deploy to staging
    needs: parse
    if: needs.parse.outputs.cmd == 'deploy'
    runs-on: ubuntu-latest
    concurrency:
      group: staging-deploy
      cancel-in-progress: false
    steps:
      - name: Ensure context is PR to staging and CI green
        id: chk
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: Number('${{ needs.parse.outputs.pr }}')
            });
            if (pr.data.base.ref !== 'staging') core.setFailed('PR target is not staging');
            // require check named "CI / build-test" success
            const checks = await github.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: pr.data.head.sha
            });
            const ok = checks.data.check_runs.some(r => r.name === 'build-test' || r.name === 'CI / build-test' || r.name.includes('build-test')) &&
              checks.data.check_runs.filter(r => (r.name === 'build-test' || r.name === 'CI / build-test' || r.name.includes('build-test'))).every(r => r.conclusion === 'success');
            if (!ok) core.setFailed('Required checks are not green: build-test');

      - name: Merge PR (squash)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ADMIN_GH_TOKEN || github.token }}
          script: |
            await github.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: Number('${{ needs.parse.outputs.pr }}'),
              merge_method: 'squash'
            });

      - name: Poll Railway until SUCCESS (max 4m)
        id: rail
        shell: bash
        env:
          RAILWAY_API_TOKEN: ${{ secrets.RAILWAY_API_TOKEN }}
        run: |
          set -euo pipefail
          echo "Polling Railway deployments for env=$STAGING_ENV_ID"
          deadline=$(( $(date +%s) + 240 ))
          while true; do
            json=$(curl -fsS -H "Authorization: Bearer ${RAILWAY_API_TOKEN}" -H 'Content-Type: application/json' \
              -d '{"query":"query($id:ID!){ project(id:$id){ services{ edges{ node{ name serviceInstances{ edges{ node{ environmentId latestDeployment{ status meta{ commitHash branch } } } } } } } } }","variables":{"id":"'"$RAILWAY_PROJECT_ID"'"}}' "$RAILWAY_GRAPHQL")
            statuses=$(echo "$json" | jq -r '.data.project.services.edges[].node | select(.name=="web" or .name=="worker" or .name=="beat") | .serviceInstances.edges[] | select(.node.environmentId==env.STAGING_ENV_ID) | .node.latestDeployment.status' --arg env "$STAGING_ENV_ID") || true
            all_ok=true
            for s in $statuses; do
              if [[ "$s" != "SUCCESS" ]]; then all_ok=false; fi
            done
            if $all_ok; then echo "ok=true" >> $GITHUB_OUTPUT; break; fi
            if (( $(date +%s) > deadline )); then echo "ok=false" >> $GITHUB_OUTPUT; echo "Timed out"; exit 1; fi
            sleep 10
          done

      - name: Health check
        id: health
        shell: bash
        run: |
          set -euo pipefail
          curl -fsS "$STAGING_BASE_URL/api/health" | jq '.'

      - name: Append to AGENTS_LOGS and push (staging)
        uses: actions/checkout@v4
        with:
          ref: staging
          fetch-depth: 0
      - name: Write log entry
        shell: bash
        env:
          PR_NUMBER: ${{ needs.parse.outputs.pr }}
        run: |
          set -euo pipefail
          ts=$(date -u +"%Y-%m-%d %H:%M UTC")
          cat >> "–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è/AGENTS_LOGS.md" <<EOF
## ${ts} ‚Äî ChatOps deploy-staging (PR #$PR_NUMBER)
- –ö–æ–º–∞–Ω–¥—ã: /deploy-staging
- –ü—Ä–æ–≤–µ—Ä–∫–∏: Railway=SUCCESS (web/worker/beat), health=ok
- –°—Å—ã–ª–∫–∏: ${STAGING_BASE_URL}/api/health
EOF
          git add "–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è/AGENTS_LOGS.md"
          git -c user.name="staging-bot" -c user.email="staging-bot@users.noreply.github.com" commit -m "docs(staging): –ª–æ–≥ –¥–µ–ø–ª–æ—è PR #$PR_NUMBER"
      - name: Push docs to staging
        env:
          PUSH_TOKEN: ${{ secrets.ADMIN_GH_TOKEN || github.token }}
        run: |
          set -euo pipefail
          git config --global http.https://github.com/.extraheader ""
          git remote set-url origin https://x-access-token:${PUSH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git
          git push origin HEAD:staging

      - name: Comment report
        uses: actions/github-script@v7
        with:
          script: |
            await github.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: Number('${{ needs.parse.outputs.pr }}'),
              body: `‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω. Railway: SUCCESS –ø–æ web/worker/beat. Health: ok (\`${process.env.STAGING_BASE_URL}/api/health\`).`
            });

  release:
    name: Release staging
    needs: parse
    if: needs.parse.outputs.cmd == 'release'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout staging
        uses: actions/checkout@v4
        with:
          ref: staging
          fetch-depth: 0
      - name: Update STAGING_STATUS.md (–°–≤–æ–±–æ–¥–µ–Ω)
        shell: bash
        env:
          AGENT: ${{ needs.parse.outputs.actor }}
          PR_NUMBER: ${{ needs.parse.outputs.pr }}
        run: |
          set -euo pipefail
          now_utc=$(date -u +"%Y-%m-%d %H:%M UTC")
          sha7=$(git rev-parse --short HEAD || echo none)
          tmp=$(mktemp)
          awk -v agent="$AGENT" -v pr="PR #$PR_NUMBER, $sha7" -v now="$now_utc" '
            BEGIN{RS=""; ORS="\n\n"}
            /^# –°—Ç–∞—Ç—É—Å —Å—Ç–µ–Ω–¥–∞ staging/ {
              n=split($0, a, /\n\n/);
              for (i=1;i<=n;i++){
                if (a[i] ~ /^## –°–µ–π—á–∞—Å/){
                  a[i] = "## –°–µ–π—á–∞—Å\n- –°—Ç–∞—Ç—É—Å: –°–≤–æ–±–æ–¥–µ–Ω\n- –ê–≥–µ–Ω—Ç: " agent "\n- PR / –∫–æ–º–º–∏—Ç: " pr "\n- –û–±–Ω–æ–≤–ª–µ–Ω–æ: " now "\n- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: –æ—Å–≤–æ–±–æ–∂–¥—ë–Ω —á–µ—Ä–µ–∑ ChatOps";
                }
              }
              for (i=1;i<=n;i++) print a[i];
              next
            }
            {print}
          ' STAGING_STATUS.md > "$tmp"
          mv "$tmp" STAGING_STATUS.md
          git add STAGING_STATUS.md
          git -c user.name="staging-bot" -c user.email="staging-bot@users.noreply.github.com" commit -m "chore(staging): –æ—Å–≤–æ–±–æ–¥–∏–ª —Å—Ç–µ–Ω–¥ (PR #$PR_NUMBER)"
      - name: Push
        env:
          PUSH_TOKEN: ${{ secrets.ADMIN_GH_TOKEN || github.token }}
        run: |
          set -euo pipefail
          git config --global http.https://github.com/.extraheader ""
          git remote set-url origin https://x-access-token:${PUSH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git
          git push origin HEAD:staging
      - name: Set STAGING_FREE status
        uses: actions/github-script@v7
        with:
          script: |
            const { data: branch } = await github.repos.getBranch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              branch: 'staging'
            });
            await github.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: branch.commit.sha,
              state: 'success',
              context: 'STAGING_FREE',
              description: 'staging —Å–≤–æ–±–æ–¥–µ–Ω',
              target_url: `${process.env["GITHUB_SERVER_URL"] || 'https://github.com'}/${context.repo.owner}/${context.repo.repo}/tree/staging`
            });
      - name: Comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: Number('${{ needs.parse.outputs.pr }}'),
              body: `üü¢ –°—Ç–µ–Ω–¥ –æ—Å–≤–æ–±–æ–∂–¥—ë–Ω.`
            });
