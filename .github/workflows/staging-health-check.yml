name: Staging Health Check

on:
  push:
    branches: [staging]
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  pull-requests: write

env:
  STAGING_BASE_URL: https://web-staging-70d1.up.railway.app
  RAILWAY_PROJECT_ID: 866bc61a-0ef1-41d1-af53-26784f6e5f06
  STAGING_ENV_ID: 9e15b55d-8220-4067-a47e-191a57c2bcca
  RAILWAY_GRAPHQL: https://backboard.railway.app/graphql/v2

jobs:
  health-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Wait for Railway deployment
        env:
          RAILWAY_API_TOKEN: ${{ secrets.RAILWAY_API_TOKEN }}
        run: |
          echo "⏳ Ждем деплоя Railway..."
          sleep 30 # Даем время Railway среагировать на пуш
          
          # Простая проверка циклами (до 5 минут)
          deadline=$(( $(date +%s) + 300 ))
          
          while true; do
             # Здесь можно использовать простой curl запрос к GraphQL или CLI если есть
             # Для простоты просто чекаем health endpoint
             
             http_code=$(curl -s -o /dev/null -w "%{http_code}" "$STAGING_BASE_URL/api/health" || echo "000")
             
             if [[ "$http_code" == "200" ]]; then
                echo "✅ Staging is alive!"
                break
             fi
             
             if (( $(date +%s) > deadline )); then
               echo "⚠️ Timeout waiting for health check"
               exit 1
             fi
             
             echo "Waiting for health 200... (Current: $http_code)"
             sleep 15
          done

      - name: Find PR associated with this commit
        id: find_pr
        uses: actions/github-script@v7
        with:
          script: |
            const { data: prs } = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha
            });
            
            if (prs.length > 0) {
              const pr = prs[0];
              core.setOutput('pr_number', pr.number);
              core.setOutput('pr_found', 'true');
            } else {
              core.setOutput('pr_found', 'false');
            }

      - name: Report Health to PR
        if: steps.find_pr.outputs.pr_found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.find_pr.outputs.pr_number }};
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `✅ **Деплой на Staging успешен!**\n\nБот доступен и отвечает на health check.\nПроверьте функционал: @test_integer_ai_bot`
            });
