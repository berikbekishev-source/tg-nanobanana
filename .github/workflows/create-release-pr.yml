name: Create Release PR (staging ‚Üí main)

on:
  workflow_dispatch:
    inputs:
      release_title:
        description: 'Release title (e.g., "Release v1.2.3" or "Hotfix: critical bug")'
        required: true
        type: string
      release_notes:
        description: 'Release notes (–∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π)'
        required: false
        type: string
        default: 'Production release from staging'

permissions:
  contents: read
  pull-requests: write

jobs:
  create-pr:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Verify staging is ahead of main
        id: check
        run: |
          git fetch origin main staging
          
          COMMITS_AHEAD=$(git rev-list --count origin/main..origin/staging)
          echo "commits_ahead=$COMMITS_AHEAD" >> "$GITHUB_OUTPUT"
          
          if [ "$COMMITS_AHEAD" -eq 0 ]; then
            echo "‚ùå Staging –Ω–µ –∏–º–µ–µ—Ç –Ω–æ–≤—ã—Ö –∫–æ–º–º–∏—Ç–æ–≤ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ main"
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          
          echo "‚úÖ Staging –≤–ø–µ—Ä–µ–¥–∏ main –Ω–∞ $COMMITS_AHEAD –∫–æ–º–º–∏—Ç–æ–≤"
          echo "has_changes=true" >> "$GITHUB_OUTPUT"
      
      - name: Get staging info
        if: steps.check.outputs.has_changes == 'true'
        id: staging_info
        run: |
          # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∫–æ–º–º–∏—Ç—ã
          RECENT_COMMITS=$(git log origin/main..origin/staging --oneline --max-count=10)
          echo "recent_commits<<EOF" >> "$GITHUB_OUTPUT"
          echo "$RECENT_COMMITS" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"
          
          # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ PR
          MERGED_PRS=$(git log origin/main..origin/staging --oneline --grep="‚Üí staging" | grep -oP '#\d+' | sort -u | head -10)
          echo "merged_prs<<EOF" >> "$GITHUB_OUTPUT"
          echo "$MERGED_PRS" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"
      
      - name: Check for existing PR
        if: steps.check.outputs.has_changes == 'true'
        id: existing_pr
        uses: actions/github-script@v7
        with:
          script: |
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:staging`,
              base: 'main'
            });
            
            if (prs.length > 0) {
              core.setOutput('exists', 'true');
              core.setOutput('pr_number', prs[0].number);
              core.setOutput('pr_url', prs[0].html_url);
              return prs[0];
            } else {
              core.setOutput('exists', 'false');
              return null;
            }
      
      - name: Create or update PR
        if: steps.check.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const existingPR = '${{ steps.existing_pr.outputs.exists }}' === 'true';
            const prNumber = '${{ steps.existing_pr.outputs.pr_number }}';
            const commitsAhead = '${{ steps.check.outputs.commits_ahead }}';
            const recentCommits = `${{ steps.staging_info.outputs.recent_commits }}`;
            const mergedPRs = `${{ steps.staging_info.outputs.merged_prs }}`;
            
            const releaseTitle = `${{ inputs.release_title }}`;
            const releaseNotes = `${{ inputs.release_notes }}`;
            
            const body = `## üöÄ Production Release

**–ó–∞–ø—Ä–æ—à–µ–Ω–æ:** ${{ github.actor }}
**–î–∞—Ç–∞:** ${new Date().toISOString().split('T')[0]}
**–ö–æ–º–º–∏—Ç–æ–≤:** ${commitsAhead}

---

### üìù –û–ø–∏—Å–∞–Ω–∏–µ:

${releaseNotes}

---

### üì¶ –í–∫–ª—é—á—ë–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:

#### –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∫–æ–º–º–∏—Ç—ã:
\`\`\`
${recentCommits}
\`\`\`

#### –°–º–µ—Ä–∂–µ–Ω–Ω—ã–µ PR:
${mergedPRs}

---

### ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ –º–µ—Ä–¥–∂–µ–º:

- [ ] Staging –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Railway staging —Å–µ—Ä–≤–∏—Å—ã = SUCCESS
- [ ] Health check –ø—Ä–æ—Ö–æ–¥–∏—Ç
- [ ] –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ
- [ ] –ù–µ—Ç –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –±–∞–≥–æ–≤
- [ ] –û–¥–æ–±—Ä–µ–Ω–æ –¥–ª—è production

---

### ‚ö†Ô∏è –ü–æ—Å–ª–µ –º–µ—Ä–¥–∂–∞:

1. ‚úÖ Railway production –∞–≤—Ç–æ–¥–µ–ø–ª–æ–π –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è
2. ‚úÖ \`post-deploy-monitor\` –ø—Ä–æ–≤–µ—Ä–∏—Ç health endpoint
3. ‚úÖ –ü—Ä–∏ —Å–±–æ–µ - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π rollback
4. ‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram

---

**üéØ –ì–æ—Ç–æ–≤ –∫ –º–µ—Ä–¥–∂—É –≤—Ä—É—á–Ω—É—é –ø–æ—Å–ª–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è!**

> ‚ö†Ô∏è **–í–ê–ñ–ù–û:** –≠—Ç–æ—Ç PR –º–µ—Ä–∂–∏—Ç—Å—è **–¢–û–õ–¨–ö–û –≤—Ä—É—á–Ω—É—é** –ø–æ—Å–ª–µ —è–≤–Ω–æ–≥–æ –æ–¥–æ–±—Ä–µ–Ω–∏—è.
> Auto-merge –¥–ª—è main –æ—Ç–∫–ª—é—á—ë–Ω.
`;

            if (existingPR) {
              // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π PR
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: parseInt(prNumber),
                title: releaseTitle,
                body: body
              });
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: parseInt(prNumber),
                body: `üîÑ **PR –æ–±–Ω–æ–≤–ª—ë–Ω**\n\n–ó–∞–ø—Ä–æ—à–µ–Ω–æ: @${{ github.actor }}\n–í—Ä–µ–º—è: ${new Date().toISOString()}\n\nStaging –±—ã–ª –æ–±–Ω–æ–≤–ª—ë–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –º–µ—Ä–¥–∂–µ–º.`
              });
              
              core.info(`‚úÖ PR #${prNumber} –æ–±–Ω–æ–≤–ª—ë–Ω`);
              core.setOutput('pr_number', prNumber);
              core.setOutput('pr_url', '${{ steps.existing_pr.outputs.pr_url }}');
            } else {
              // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π PR
              const { data: pr } = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: releaseTitle,
                body: body,
                head: 'staging',
                base: 'main'
              });
              
              core.info(`‚úÖ PR #${pr.number} —Å–æ–∑–¥–∞–Ω`);
              core.setOutput('pr_number', pr.number);
              core.setOutput('pr_url', pr.html_url);
            }
      
      - name: Summary
        if: steps.check.outputs.has_changes == 'true'
        run: |
          echo "## üéØ Release PR —Å–æ–∑–¥–∞–Ω/–æ–±–Ω–æ–≤–ª—ë–Ω" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR URL:** ${{ steps.existing_pr.outputs.pr_url || steps.create-pr.outputs.pr_url }}" >> $GITHUB_STEP_SUMMARY
          echo "**–ö–æ–º–º–∏—Ç–æ–≤:** ${{ steps.check.outputs.commits_ahead }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚ö†Ô∏è **–ú–µ—Ä–¥–∂ —Ç–æ–ª—å–∫–æ –≤—Ä—É—á–Ω—É—é –ø–æ—Å–ª–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è!**" >> $GITHUB_STEP_SUMMARY
      
      - name: No changes summary
        if: steps.check.outputs.has_changes == 'false'
        run: |
          echo "## ‚ÑπÔ∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è —Ä–µ–ª–∏–∑–∞" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Staging –Ω–µ –∏–º–µ–µ—Ç –Ω–æ–≤—ã—Ö –∫–æ–º–º–∏—Ç–æ–≤ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ main." >> $GITHUB_STEP_SUMMARY
          echo "PR –Ω–µ —Å–æ–∑–¥–∞–Ω." >> $GITHUB_STEP_SUMMARY

