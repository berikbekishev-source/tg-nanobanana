name: ChatOps Router

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  actions: write
  issues: read
  pull-requests: read

jobs:
  route:
    runs-on: ubuntu-latest
    steps:
      - name: Route slash command â†’ workflow_dispatch
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ADMIN_GH_TOKEN || github.token }}
          script: |
            const body = (context.payload.comment?.body || '').trim();
            const isPR = !!context.payload.issue?.pull_request;
            if (!isPR) return core.info('Not a PR comment, skipping');
            const pr = context.payload.issue.number;
            const actor = context.actor;
            function parseReserve(s){
              const m = s.match(/^\/reserve-staging\s+(\d+)(m|h)?/i);
              const ttl = m ? `${m[1]}${m[2]||'m'}` : '15m';
              const reason = (s.match(/reason:(.+)$/i)?.[1] || '').trim();
              return {ttl, reason};
            }
            let action = '';
            let ttl = '';
            let reason = '';
            if (/^\/reserve-staging\b/i.test(body)) {
              ({ttl, reason} = parseReserve(body));
              action = 'reserve';
            } else if (/^\/deploy-staging\b/i.test(body)) {
              action = 'deploy';
            } else if (/^\/release-staging\b/i.test(body)) {
              action = 'release';
            } else {
              core.info('No matching command');
              return;
            }
            const workflow = 'staging-ops.yml';
            const ref = context.payload.repository?.default_branch || 'main';
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: workflow,
              ref,
              inputs: {
                action,
                pr: String(pr),
                ttl: ttl || '15m',
                reason: reason || '',
                actor
              }
            });
            core.info(`Dispatched staging-ops with action=${action} for PR #${pr}`);
