name: ChatOps Router

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  actions: write
  issues: read
  pull-requests: read

jobs:
  route:
    runs-on: ubuntu-latest
    steps:
      - name: Route slash command
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ADMIN_GH_TOKEN || github.token }}
          script: |
            const body = (context.payload.comment?.body || '').trim();
            const isPR = !!context.payload.issue?.pull_request;
            if (!isPR) return core.info('Not a PR comment, skipping');
            const pr = context.payload.issue.number;
            const actor = context.actor;

            function parseReserve(s){
              const m = s.match(/^\/reserve-staging\s+(\d+)(m|h)?/i);
              const ttl = m ? `${m[1]}${m[2]||'m'}` : '15m';
              const reason = (s.match(/reason:(.+)$/i)?.[1] || '').trim();
              return {ttl, reason};
            }

            let evt = '';
            let payload = {pr, actor};
            if (/^\/reserve-staging\b/i.test(body)) {
              const {ttl, reason} = parseReserve(body);
              evt = 'reserve-staging'; payload = {...payload, ttl, reason};
            } else if (/^\/deploy-staging\b/i.test(body)) {
              evt = 'deploy-staging';
            } else if (/^\/release-staging\b/i.test(body)) {
              evt = 'release-staging';
            } else {
              core.info('No matching command'); return;
            }

            const workflow = 'staging-ops.yml';
            const ref = context.payload.repository?.default_branch || 'main';
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: workflow,
              ref,
              inputs: {
                action: evt.replace('-staging',''),
                pr: String(pr),
                ttl: String(payload.ttl || ''),
                reason: String(payload.reason || ''),
                actor
              }
            });
            core.info(`Workflow dispatch sent: ${evt} for PR #${pr}`);
name: ChatOps Router

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  actions: write
  issues: read
  pull-requests: read

jobs:
  parse:
    runs-on: ubuntu-latest
    outputs:
      action: ${{ steps.p.outputs.action }}
      pr: ${{ steps.p.outputs.pr }}
      ttl: ${{ steps.p.outputs.ttl }}
      reason: ${{ steps.p.outputs.reason }}
      actor: ${{ steps.p.outputs.actor }}
    steps:
      - name: Parse slash command
        id: p
        uses: actions/github-script@v7
        with:
          script: |
            const body = (context.payload.comment?.body || '').trim();
            const isPR = !!context.payload.issue?.pull_request;
            if (!isPR) { core.setOutput('action',''); return; }
            const pr = String(context.payload.issue.number);
            const actor = context.actor;
            function parseReserve(s){
              const m = s.match(/^\/reserve-staging\s+(\d+)(m|h)?/i);
              const ttl = m ? `${m[1]}${m[2]||'m'}` : '15m';
              const reason = (s.match(/reason:(.+)$/i)?.[1] || '').trim();
              return {ttl, reason};
            }
            let action = '';
            let ttl = '';
            let reason = '';
            if (/^\/reserve-staging\b/i.test(body)) {
              const res = parseReserve(body); ttl = res.ttl; reason = res.reason; action = 'reserve';
            } else if (/^\/deploy-staging\b/i.test(body)) {
              action = 'deploy';
            } else if (/^\/release-staging\b/i.test(body)) {
              action = 'release';
            }
            core.setOutput('action', action);
            core.setOutput('pr', pr);
            core.setOutput('ttl', ttl);
            core.setOutput('reason', reason);
            core.setOutput('actor', actor);

  staging_ops:
    needs: parse
    if: ${{ needs.parse.outputs.action != '' }}
    uses: ./.github/workflows/staging-ops.yml
    with:
      action: ${{ needs.parse.outputs.action }}
      pr: ${{ needs.parse.outputs.pr }}
      ttl: ${{ needs.parse.outputs.ttl || '15m' }}
      reason: ${{ needs.parse.outputs.reason }}
      actor: ${{ needs.parse.outputs.actor }}
