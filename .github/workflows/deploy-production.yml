name: Deploy to Production (Railway)

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [main]

permissions:
  contents: read

env:
  RAILWAY_GRAPHQL: https://backboard.railway.app/graphql/v2
  RAILWAY_PROJECT_ID: 866bc61a-0ef1-41d1-af53-26784f6e5f06
  PRODUCTION_ENV_ID: 2eee50d8-402e-44bf-9035-8298efef91bc

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main' && vars.RAILWAY_API_TOKEN != '' && vars.PRODUCTION_BASE_URL != '' }}
    runs-on: ubuntu-latest
    env:
      RAILWAY_TOKEN: ${{ vars.RAILWAY_API_TOKEN }}
      PRODUCTION_BASE_URL: ${{ vars.PRODUCTION_BASE_URL }}
      COMMIT_SHA: ${{ github.event.workflow_run.head_sha }}
    steps:
      - name: Install Railway CLI
        run: |
          curl -sSL https://railway.app/install.sh | sh
          echo "$HOME/.railway/bin" >> "$GITHUB_PATH"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0

      - name: Trigger Railway deployment
        id: deploy
        run: |
          set -euo pipefail
          
          echo "üöÄ –ó–∞–ø—É—Å–∫ –¥–µ–ø–ª–æ—è –Ω–∞ Railway –¥–ª—è –∫–æ–º–º–∏—Ç–∞ ${COMMIT_SHA:0:7}"
          
          # Railway –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–µ–ø–ª–æ–∏—Ç –ø—Ä–∏ –ø—É—à–µ –≤ –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—É—é –≤–µ—Ç–∫—É —á–µ—Ä–µ–∑ GitHub integration
          # –ù–æ –º—ã –º–æ–∂–µ–º —è–≤–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –¥–µ–ø–ª–æ–π —á–µ—Ä–µ–∑ API
          
          # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–∏—Å–æ–≤
          SERVICES_QUERY='query($id:ID!){ project(id:$id){ services{ edges{ node{ id name serviceInstances{ edges{ node{ id environmentId } } } } } } } }'
          
          SERVICES_RESPONSE=$(curl -s -X POST "$RAILWAY_GRAPHQL" \
            -H "Authorization: Bearer $RAILWAY_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"query\":\"$SERVICES_QUERY\",\"variables\":{\"id\":\"$RAILWAY_PROJECT_ID\"}}")
          
          echo "Services response: $SERVICES_RESPONSE" | head -c 500
          
          # –ò–∑–≤–ª–µ–∫–∞–µ–º ID —Å–µ—Ä–≤–∏—Å–æ–≤ –¥–ª—è production environment
          WEB_SERVICE_ID=$(echo "$SERVICES_RESPONSE" | jq -r --arg EID "$PRODUCTION_ENV_ID" '.data.project.services.edges[].node | select(.name=="web") | .serviceInstances.edges[] | select(.node.environmentId==$EID) | .node.id' | head -1)
          WORKER_SERVICE_ID=$(echo "$SERVICES_RESPONSE" | jq -r --arg EID "$PRODUCTION_ENV_ID" '.data.project.services.edges[].node | select(.name=="worker") | .serviceInstances.edges[] | select(.node.environmentId==$EID) | .node.id' | head -1)
          BEAT_SERVICE_ID=$(echo "$SERVICES_RESPONSE" | jq -r --arg EID "$PRODUCTION_ENV_ID" '.data.project.services.edges[].node | select(.name=="beat") | .serviceInstances.edges[] | select(.node.environmentId==$EID) | .node.id' | head -1)
          
          echo "Web service instance ID: $WEB_SERVICE_ID"
          echo "Worker service instance ID: $WORKER_SERVICE_ID"
          echo "Beat service instance ID: $BEAT_SERVICE_ID"
          
          # Railway –æ–±—ã—á–Ω–æ –¥–µ–ø–ª–æ–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ GitHub webhook
          # –ù–æ –µ—Å–ª–∏ —ç—Ç–æ–≥–æ –Ω–µ –ø—Ä–æ–∏–∑–æ—à–ª–æ, –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Railway CLI –¥–ª—è —è–≤–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è
          # –ò–ª–∏ –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –¥–µ–ø–ª–æ–π –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
          
          echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–µ–ø–ª–æ—è Railway (–º–∞–∫—Å 2 –º–∏–Ω—É—Ç—ã)..."
          deadline=$(( $(date +%s) + 120 ))
          
          while true; do
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –¥–µ–ø–ª–æ—è
            DEPLOY_QUERY='query($id:ID!){ project(id:$id){ services{ edges{ node{ name serviceInstances{ edges{ node{ environmentId latestDeployment{ status createdAt meta{ commitHash } } } } } } } } } }'
            
            DEPLOY_RESPONSE=$(curl -s -X POST "$RAILWAY_GRAPHQL" \
              -H "Authorization: Bearer $RAILWAY_TOKEN" \
              -H "Content-Type: application/json" \
              -d "{\"query\":\"$DEPLOY_QUERY\",\"variables\":{\"id\":\"$RAILWAY_PROJECT_ID\"}}")
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –¥–µ–ø–ª–æ–π –¥–ª—è –Ω—É–∂–Ω–æ–≥–æ –∫–æ–º–º–∏—Ç–∞ –∑–∞–ø—É—â–µ–Ω –∏–ª–∏ –∑–∞–≤–µ—Ä—à–µ–Ω
            CURRENT_COMMIT=$(echo "$DEPLOY_RESPONSE" | jq -r --arg EID "$PRODUCTION_ENV_ID" '.data.project.services.edges[].node | select(.name=="web") | .serviceInstances.edges[] | select(.node.environmentId==$EID) | .node.latestDeployment.meta.commitHash' | head -1)
            DEPLOY_STATUS=$(echo "$DEPLOY_RESPONSE" | jq -r --arg EID "$PRODUCTION_ENV_ID" '.data.project.services.edges[].node | select(.name=="web") | .serviceInstances.edges[] | select(.node.environmentId==$EID) | .node.latestDeployment.status' | head -1)
            
            echo "–¢–µ–∫—É—â–∏–π –∫–æ–º–º–∏—Ç –≤ Railway: ${CURRENT_COMMIT:0:7}, —Å—Ç–∞—Ç—É—Å: $DEPLOY_STATUS"
            
            if [ "${CURRENT_COMMIT:0:7}" = "${COMMIT_SHA:0:7}" ] && [ "$DEPLOY_STATUS" = "SUCCESS" ]; then
              echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
              echo "deployed=true" >> $GITHUB_OUTPUT
              break
            fi
            
            if [ "${CURRENT_COMMIT:0:7}" = "${COMMIT_SHA:0:7}" ] && [ "$DEPLOY_STATUS" = "BUILDING" ] || [ "$DEPLOY_STATUS" = "DEPLOYING" ]; then
              echo "‚è≥ –î–µ–ø–ª–æ–π –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ..."
            fi
            
            if (( $(date +%s) > deadline )); then
              echo "‚ö†Ô∏è –¢–∞–π–º–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è –¥–µ–ø–ª–æ—è. Railway –¥–æ–ª–∂–µ–Ω –¥–µ–ø–ª–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ GitHub webhook."
              echo "deployed=timeout" >> $GITHUB_OUTPUT
              break
            fi
            
            sleep 10
          done

      - name: Wait for Railway deployment to complete
        if: steps.deploy.outputs.deployed == 'true'
        run: |
          set -euo pipefail
          echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–µ–ø–ª–æ—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤..."
          deadline=$(( $(date +%s) + 300 ))
          
          while true; do
            DEPLOY_QUERY='query($id:ID!){ project(id:$id){ services{ edges{ node{ name serviceInstances{ edges{ node{ environmentId latestDeployment{ status meta{ commitHash } } } } } } } } } }'
            
            DEPLOY_RESPONSE=$(curl -s -X POST "$RAILWAY_GRAPHQL" \
              -H "Authorization: Bearer $RAILWAY_TOKEN" \
              -H "Content-Type: application/json" \
              -d "{\"query\":\"$DEPLOY_QUERY\",\"variables\":{\"id\":\"$RAILWAY_PROJECT_ID\"}}")
            
            STATUSES=$(echo "$DEPLOY_RESPONSE" | jq -r --arg EID "$PRODUCTION_ENV_ID" '.data.project.services.edges[].node | select(.name=="web" or .name=="worker" or .name=="beat") | .serviceInstances.edges[] | select(.node.environmentId==$EID) | .node.latestDeployment.status' | head -3)
            
            all_success=true
            for status in $STATUSES; do
              if [ "$status" != "SUCCESS" ]; then
                all_success=false
                break
              fi
            done
            
            if $all_success; then
              echo "‚úÖ –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∑–∞–¥–µ–ø–ª–æ–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"
              break
            fi
            
            if (( $(date +%s) > deadline )); then
              echo "‚ö†Ô∏è –¢–∞–π–º–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–µ–ø–ª–æ—è"
              exit 1
            fi
            
            echo "–°—Ç–∞—Ç—É—Å—ã –¥–µ–ø–ª–æ—è: $STATUSES"
            sleep 10
          done

      - name: Health check
        run: |
          set -euo pipefail
          echo "üè• –ü—Ä–æ–≤–µ—Ä–∫–∞ health endpoint..."
          
          for i in $(seq 1 30); do
            code=$(curl -s -o /dev/null -w "%{http_code}" "$PRODUCTION_BASE_URL/api/health" || true)
            echo "–ü–æ–ø—ã—Ç–∫–∞ $i: HTTP $code"
            if [ "$code" = "200" ]; then
              echo "‚úÖ Health check —É—Å–ø–µ—à–µ–Ω!"
              curl -s "$PRODUCTION_BASE_URL/api/health" | jq '.'
              exit 0
            fi
            sleep 10
          done
          
          echo "‚ùå Health check –Ω–µ –ø—Ä–æ—à–µ–ª"
          exit 1

