name: Set Telegram Webhook

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment (staging or production)'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  set-webhook:
    runs-on: ubuntu-latest
    steps:
      - name: Determine variables
        id: vars
        run: |
          ENV="${{ github.event.inputs.environment }}"
          if [ "$ENV" = "staging" ]; then
            echo "token=${{ secrets.STAGING_TELEGRAM_BOT_TOKEN }}" >> $GITHUB_OUTPUT
            echo "secret=${{ secrets.STAGING_TG_WEBHOOK_SECRET }}" >> $GITHUB_OUTPUT
            echo "base=${{ secrets.STAGING_BASE_URL }}" >> $GITHUB_OUTPUT
          else
            echo "token=${{ secrets.PROD_TELEGRAM_BOT_TOKEN }}" >> $GITHUB_OUTPUT
            echo "secret=${{ secrets.PROD_TG_WEBHOOK_SECRET }}" >> $GITHUB_OUTPUT
            echo "base=${{ secrets.PRODUCTION_BASE_URL }}" >> $GITHUB_OUTPUT
          fi
      - name: Validate inputs
        run: |
          test -n "${{ steps.vars.outputs.token }}" || (echo "Missing Telegram token secret" && exit 1)
          test -n "${{ steps.vars.outputs.secret }}" || (echo "Missing TG_WEBHOOK_SECRET secret" && exit 1)
          test -n "${{ steps.vars.outputs.base }}" || (echo "Missing BASE_URL secret" && exit 1)
      - name: Set webhook
        env:
          TOKEN: ${{ steps.vars.outputs.token }}
          SECRET: ${{ steps.vars.outputs.secret }}
          BASE: ${{ steps.vars.outputs.base }}
        run: |
          set -euo pipefail
          URL="${BASE%/}/api/telegram/webhook"
          echo "Setting webhook to $URL"
          curl -fsSL -X POST \
            "https://api.telegram.org/bot${TOKEN}/setWebhook" \
            -d "url=$URL" \
            -d "secret_token=$SECRET" \
            -d "allowed_updates=\"[\"message\"]\""
