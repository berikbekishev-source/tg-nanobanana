name: AI Reviewer Auto-Approve and Auto-Merge

on:
  pull_request:
    branches: [ "staging", "main" ]
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  approve-and-automerge:
    runs-on: ubuntu-latest
    steps:
      - name: Basic heuristics (no secrets in diff)
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const prNumber = context.payload.pull_request.number;
            const { data: files } = await github.rest.pulls.listFiles({ owner, repo, pull_number: prNumber, per_page: 100 });
            const risky = files.some(f => /\.env|id_rsa|\.pem|secret|token/i.test(f.filename));
            if (risky) {
              core.setFailed('Potentially sensitive files in PR');
            }
      - name: Approve PR as AI reviewer
        if: ${{ success() }}
        uses: hmarr/auto-approve-action@v4
        with:
          review-message: "Авто-ревью: базовые проверки пройдены. Ожидаем статус-проверки CI."
        env:
          GITHUB_TOKEN: ${{ secrets.ADMIN_GH_TOKEN }}
      - name: Enable auto-merge (squash)
        if: ${{ success() }}
        uses: peter-evans/enable-pull-request-automerge@v3
        continue-on-error: true
        with:
          token: ${{ secrets.ADMIN_GH_TOKEN }}
          merge-method: squash
