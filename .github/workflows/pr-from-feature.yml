name: Open PR to staging on push

on:
  push:
    branches-ignore:
      - main
      - staging

permissions:
  contents: read
  pull-requests: write

jobs:
  open-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Create or update PR to staging
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ADMIN_GH_TOKEN }}
          script: |
            const base = 'staging';
            const head = context.ref.replace('refs/heads/','');
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            // If branch equals base or main, skip
            if (['staging','main'].includes(head)) {
              core.info(`Skip branch ${head}`);
              return;
            }
            // Check if PR exists
            const { data: prs } = await github.rest.pulls.list({ owner, repo, state: 'open', base, head: `${owner}:${head}` });
            if (prs.length > 0) {
              core.info(`PR already exists: ${prs[0].html_url}`);
              return;
            }
            const title = `feat: ${head} â†’ staging`;
            const body = 'Automated PR created on push to feature branch.';
            const { data: pr } = await github.rest.pulls.create({ owner, repo, title, head, base, body, maintainer_can_modify: true });
            core.info(`PR created: ${pr.html_url}`);
