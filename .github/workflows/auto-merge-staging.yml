name: Auto-merge to staging

on:
  pull_request:
    # –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ PR –≤ staging
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [staging]

permissions:
  contents: write
  pull-requests: write

jobs:
  fast-merge:
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ —á–µ—Ä–Ω–æ–≤–∏–∫
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    steps:
      - name: Wait for Lint to pass
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const sha = pr.head.sha;
            
            console.log(`Checking status for commit ${sha}...`);
            
            // –ñ–¥–µ–º –º–∞–∫—Å–∏–º—É–º 2 –º–∏–Ω—É—Ç—ã (–ª–∏–Ω—Ç–µ—Ä –±—ã—Å—Ç—Ä—ã–π)
            const maxRetries = 12; 
            
            for (let i = 0; i < maxRetries; i++) {
              const { data: checkRuns } = await github.rest.checks.listForRef({
                owner, repo, ref: sha, filter: 'latest'
              });
              
              const lintCheck = checkRuns.check_runs.find(c => c.name === 'lint');
              
              if (lintCheck) {
                 console.log(`Lint status: ${lintCheck.status}, Conclusion: ${lintCheck.conclusion}`);
                 
                 if (lintCheck.status === 'completed') {
                   if (lintCheck.conclusion === 'success') {
                     console.log('‚úÖ Lint passed!');
                     return;
                   } else {
                     core.setFailed('‚ùå Lint failed. Fix syntax errors.');
                     return;
                   }
                 }
              } else {
                 console.log('Lint check not found yet...');
              }
              
              await new Promise(r => setTimeout(r, 10000));
            }
            core.setFailed('Timeout waiting for Lint.');

      - name: Merge PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ADMIN_GH_TOKEN || github.token }}
          script: |
            const pr = context.payload.pull_request;
            
            try {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                merge_method: 'squash',
                commit_title: `${pr.title} (#${pr.number})`,
                commit_message: 'Fast-track merge to staging üöÄ'
              });
              console.log(`‚úÖ PR #${pr.number} merged successfully`);
            } catch (error) {
              console.log(`‚ö†Ô∏è Merge failed: ${error.message}`);
              // –ï—Å–ª–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç –∏–ª–∏ –¥—Ä—É–≥–æ–µ - –Ω–µ —Ñ–µ–π–ª–∏–º –±–∏–ª–¥, –ø—Ä–æ—Å—Ç–æ –æ—Å—Ç–∞–≤–ª—è–µ–º PR –≤–∏—Å–µ—Ç—å
              if (error.message.includes('Merge conflict')) {
                 core.info('‚ö†Ô∏è Merge conflict detected. Manual intervention required.');
              } else {
                 core.setFailed(error.message);
              }
            }
