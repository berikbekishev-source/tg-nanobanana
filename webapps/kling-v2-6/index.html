<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kling v2-6 ¬∑ INTEGER</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: #0f1c2d;
            --pane: #14263c;
            --pane-2: #1a324f;
            --text: #f2f4f8;
            --muted: #9fb4cc;
            --accent: #f19b28;
            --accent-2: #f6b24f;
            --danger: #ff6b6b;
            --border: #223956;
            --radius: 18px;
            --shadow: 0 14px 40px rgba(0, 0, 0, 0.4);
            --dot: radial-gradient(circle, rgba(255, 255, 255, 0.06) 1px, transparent 0);
            --font: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 18px 16px 24px;
            font-family: var(--font);
            color: var(--text);
            background: var(--bg);
            background-image: var(--dot);
            background-size: 22px 22px;
        }

        .card {
            background: linear-gradient(145deg, var(--pane) 0%, #111c2f 60%, #0f1c2d 100%);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 16px 16px 10px;
            position: relative;
            overflow: hidden;
        }

        .card::after {
            content: "";
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 20% 20%, rgba(241, 155, 40, 0.15), transparent 45%),
                radial-gradient(circle at 80% 10%, rgba(246, 178, 79, 0.08), transparent 35%);
            pointer-events: none;
        }

        .header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .badge {
            width: 44px;
            height: 44px;
            border-radius: 14px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
            color: #0f1c2d;
            font-weight: 800;
            font-size: 17px;
            display: grid;
            place-items: center;
            box-shadow: 0 10px 28px rgba(241, 155, 40, 0.35);
        }

        h1 {
            font-size: 18px;
            font-weight: 800;
            margin: 0;
            letter-spacing: 0.1px;
        }

        .sub {
            font-size: 13px;
            color: var(--muted);
            margin: 2px 0 0;
        }

        .section {
            background: rgba(20, 38, 60, 0.7);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 14px;
            margin: 12px 0;
        }

        .section-title {
            font-size: 14px;
            font-weight: 700;
            margin: 0 0 10px;
        }

        .chip-toggle {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .chip {
            background: #0f1c2d;
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 14px;
            padding: 12px;
            font-size: 14px;
            font-weight: 700;
            text-align: center;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .chip.active {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
            color: #04101f;
            box-shadow: 0 10px 24px rgba(241, 155, 40, 0.35);
        }

        .chip.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .label {
            font-size: 13px;
            color: var(--muted);
            margin: 10px 0 6px;
        }

        textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            background: #0a1222;
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text);
            font-size: 14px;
            resize: vertical;
            outline: none;
            transition: border-color 0.15s ease;
        }

        textarea:focus {
            border-color: var(--accent);
        }

        .count {
            font-size: 12px;
            color: var(--muted);
            text-align: right;
            margin-top: 4px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .pill {
            background: #0f1c2d;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 10px;
            text-align: center;
            font-weight: 700;
            font-size: 14px;
            color: var(--text);
            cursor: pointer;
            transition: all 0.12s ease;
        }

        .pill.active {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
            color: #0f1c2d;
            box-shadow: 0 8px 20px rgba(241, 155, 40, 0.28);
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è –∞—É–¥–∏–æ */
        .toggle-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
        }

        .toggle-label {
            font-size: 14px;
            font-weight: 700;
            color: var(--text);
        }

        .toggle-switch {
            position: relative;
            width: 52px;
            height: 28px;
            background: #0f1c2d;
            border: 1px solid var(--border);
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .toggle-switch.active {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
            border-color: var(--accent);
        }

        .toggle-switch::after {
            content: "";
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: var(--text);
            border-radius: 50%;
            transition: transform 0.2s ease;
        }

        .toggle-switch.active::after {
            transform: translateX(24px);
            background: #0f1c2d;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –±–ª–æ–∫–æ–≤ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π */
        .upload-section {
            margin-top: 12px;
        }

        .upload-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .upload-title {
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text);
            line-height: 1.3;
        }

        .upload-hint {
            font-size: 12px;
            color: var(--muted);
            text-align: right;
            white-space: nowrap;
        }

        .upload-box {
            border: 2px dashed var(--border);
            border-radius: 16px;
            background: rgba(15, 28, 45, 0.5);
            min-height: 180px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.15s ease;
            position: relative;
            overflow: hidden;
        }

        .upload-box:hover {
            border-color: var(--accent);
            background: rgba(241, 155, 40, 0.05);
        }

        .upload-box.has-file {
            border-style: solid;
            border-color: var(--accent);
        }

        .upload-box input[type="file"] {
            position: absolute;
            inset: 0;
            opacity: 0;
            cursor: pointer;
        }

        .upload-icon {
            font-size: 32px;
            color: var(--muted);
            margin-bottom: 8px;
        }

        .upload-text {
            font-size: 14px;
            color: var(--muted);
        }

        .upload-preview {
            width: 100%;
            height: 100%;
            object-fit: contain;
            max-height: 180px;
        }

        .upload-file-info {
            position: absolute;
            bottom: 8px;
            left: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.7);
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 12px;
            color: var(--text);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .upload-remove {
            color: var(--danger);
            cursor: pointer;
            font-weight: 700;
        }

        .upload-error {
            color: var(--danger);
            font-size: 12px;
            margin-top: 6px;
        }

        .error {
            color: var(--danger);
            font-size: 13px;
            margin-top: 6px;
        }

        .muted {
            color: var(--muted);
            font-size: 13px;
            line-height: 1.5;
            margin: 8px 0 0;
        }

        @media (min-width: 640px) {
            body {
                padding: 28px;
            }

            .card {
                max-width: 640px;
                margin: 0 auto;
            }
        }
    </style>
</head>

<body>
    <div class="card">
        <div class="header">
            <div class="badge">üêâ</div>
            <div>
                <h1>Kling v2-6</h1>
                <p class="sub">–í–∏–¥–µ–æ –∏–∑ —Ç–µ–∫—Å—Ç–∞ –∏–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å Native Audio</p>
            </div>
        </div>

        <div class="section">
            <p class="section-title">–†–µ–∂–∏–º</p>
            <div class="chip-toggle" id="modeToggle">
                <div class="chip active" data-mode="text2video">–¢–µ–∫—Å—Ç ‚Üí –í–∏–¥–µ–æ</div>
                <div class="chip" data-mode="image2video">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ ‚Üí –í–∏–¥–µ–æ</div>
            </div>
            <p class="muted">
                –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ä–æ–ª–∏–∫–∞ 5‚Äì10 —Å–µ–∫—É–Ω–¥. –§–æ—Ä–º–∞—Ç –∫–∞–¥—Ä–∞ –∑–∞–¥–∞—ë—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–∫—Å—Ç–∞ ‚Äî –≤ Image ‚Üí Video
                –±–µ—Ä—ë–º —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å—Ç–æ—Ä–æ–Ω –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.
            </p>
        </div>

        <div class="section">
            <p class="section-title">–ü—Ä–æ–º—Ç</p>
            <p class="label">–¢–µ–∫—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å</p>
            <textarea id="prompt" placeholder="–û–ø–∏—à–∏—Ç–µ —Å—é–∂–µ—Ç –∏–ª–∏ —Å—Ü–µ–Ω—É..." maxlength="2500" enterkeyhint="done"
                inputmode="text"></textarea>
            <div class="count" id="promptCount">0/2500</div>
        </div>

        <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –∞—É–¥–∏–æ -->
        <div class="section" id="audioSection">
            <p class="section-title">–ê—É–¥–∏–æ</p>
            <div class="toggle-row">
                <span class="toggle-label">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å –∞—É–¥–∏–æ</span>
                <div class="toggle-switch" id="audioToggle"></div>
            </div>
            <p class="muted">
                Native Audio ‚Äî AI-–≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º—ã–π –∑–≤—É–∫, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å –≤–∏–¥–µ–æ.
                –ü—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ä–µ–∂–∏–º Pro.
            </p>
        </div>

        <!-- –ë–ª–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è image2video -->
        <div class="section" id="imageUploadSection" style="display:none;">
            <p class="section-title">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</p>

            <!-- –ù–∞—á–∞–ª—å–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ -->
            <div class="upload-section">
                <div class="upload-header">
                    <span class="upload-title">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ<br>(–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</span>
                    <span class="upload-hint">JPG/PNG ‚Ä¢ ‚â§ 10 –ú–ë</span>
                </div>
                <div class="upload-box" id="startImageBox">
                    <input type="file" id="startImageInput" accept="image/jpeg,image/png,image/webp">
                    <div class="upload-icon">+</div>
                    <div class="upload-text">–ó–∞–≥—Ä—É–∑–∏—Ç—å</div>
                </div>
                <div class="upload-error" id="startImageError"></div>
            </div>
        </div>

        <div class="section" id="formatSection">
            <p class="section-title">–§–æ—Ä–º–∞—Ç –∫–∞–¥—Ä–∞</p>
            <div class="grid" id="ratioGrid">
                <div class="pill active" data-ratio="16:9">16:9</div>
                <div class="pill" data-ratio="9:16">9:16</div>
                <div class="pill" data-ratio="1:1">1:1</div>
            </div>
        </div>

        <div class="section">
            <p class="section-title">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</p>
            <div class="chip-toggle" id="durationToggle">
                <div class="chip active" data-duration="5">5 —Å–µ–∫—É–Ω–¥</div>
                <div class="chip" data-duration="10">10 —Å–µ–∫—É–Ω–¥</div>
            </div>
        </div>

        <div class="section">
            <p class="section-title">–ü–æ–¥—Å–∫–∞–∑–∫–∞</p>
            <p class="muted">
                Text ‚Üí Video: —É–∫–∞–∂–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç –∫–∞–¥—Ä–∞ –∏ –∫—Ä–∞—Ç–∫–∏–π —Å—é–∂–µ—Ç. <br>
                Image ‚Üí Video: –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ä–µ—Ñ–µ—Ä–µ–Ω—Å –∏ –¥–æ–±–∞–≤—å—Ç–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–≤–∏–∂–µ–Ω–∏—è. <br>
                –ü—Ä–∏–º–µ—Ä—ã: ¬´–¥—Ä–æ–Ω –ª–µ—Ç–∏—Ç –Ω–∞–¥ –Ω–æ—á–Ω—ã–º –≥–æ—Ä–æ–¥–æ–º¬ª –∏–ª–∏ ¬´–∞–∫–≤–∞—Ä–µ–ª—å–Ω—ã–π –∫–∏—Ç –ø–ª—ã–≤—ë—Ç —Å–∫–≤–æ–∑—å –æ–±–ª–∞–∫–∞¬ª.
            </p>
        </div>

        <div id="error" class="error" style="display:none;"></div>

    </div>

    <script>
        const tg = window.Telegram?.WebApp;

        // Global error handler for debugging
        window.onerror = function (msg, url, line, col, error) {
            if (tg) tg.showAlert(`Error: ${msg}\nLine: ${line}`);
            return false;
        };

        const params = new URLSearchParams(window.location.search);
        const MAX_IMAGE_SIZE = 10 * 1024 * 1024; // 10 MB

        // –¶–µ–Ω—ã –≤ USD –∑–∞ —Å–µ–∫—É–Ω–¥—É
        const PRICE_PER_SECOND_STD = 0.055;  // kling-v2-6
        const PRICE_PER_SECOND_AUDIO = 0.07; // kling-v2-6-pro-with-sound

        const state = {
            modelSlug: params.get("model") || "kling-v2-6",
            generationType: "text2video",
            enableAudio: false,
            prompt: "",
            aspectRatio: "16:9",
            duration: Number(params.get("duration")) || 5,
            // –ù–∞—á–∞–ª—å–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (presigned URL)
            imageUrl: null,
            imageSize: 0,
            imageMime: null,
            imageName: null,
            imageUploading: false,
            // Pricing
            priceLabel: "‚Äî",
            tokensPerSecondStd: null,
            tokensPerSecondAudio: null,
        };

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ presigned URL –≤ Supabase
        async function uploadToSupabase(file) {
            const resp = await fetch('/api/storage/presigned-upload', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content_type: file.type })
            });
            if (!resp.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å URL');
            const { upload_url, public_url } = await resp.json();
            const upload = await fetch(upload_url, {
                method: 'PUT',
                headers: { 'Content-Type': file.type },
                body: file
            });
            if (!upload.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å');
            return public_url;
        }

        const els = {
            modeToggle: document.getElementById("modeToggle"),
            audioToggle: document.getElementById("audioToggle"),
            audioSection: document.getElementById("audioSection"),
            ratioGrid: document.getElementById("ratioGrid"),
            prompt: document.getElementById("prompt"),
            promptCount: document.getElementById("promptCount"),
            imageUploadSection: document.getElementById("imageUploadSection"),
            startImageBox: document.getElementById("startImageBox"),
            startImageInput: document.getElementById("startImageInput"),
            startImageError: document.getElementById("startImageError"),
            durationToggle: document.getElementById("durationToggle"),
            formatSection: document.getElementById("formatSection"),
            error: document.getElementById("error"),
        };

        state.duration = sanitizeDuration(state.duration);

        function setActive(container, target) {
            container.querySelectorAll(".chip, .pill").forEach(btn => btn.classList.remove("active"));
            target.classList.add("active");
        }

        function updateCounts() {
            state.prompt = els.prompt.value.trim();
            els.promptCount.textContent = `${state.prompt.length}/2500`;
            if (tg?.MainButton) {
                if (state.prompt.length > 0) {
                    tg.MainButton.show();
                } else {
                    tg.MainButton.hide();
                }
            }
        }

        function setError(text) {
            if (tg) {
                if (text) tg.showAlert(text);
            } else {
                els.error.textContent = text;
                els.error.style.display = text ? "block" : "none";
            }
        }

        function parseTokens(label) {
            if (!label) return null;
            const match = String(label).replace(",", ".").match(/([0-9]+(?:\.[0-9]+)?)/);
            if (!match) return null;
            const value = Number(match[1]);
            return Number.isFinite(value) ? value : null;
        }

        function formatPrice(tokens) {
            if (!Number.isFinite(tokens)) return "‚Äî";
            return `‚ö°${tokens.toFixed(2)} —Ç–æ–∫–µ–Ω–æ–≤`;
        }

        function setPriceLabel(label) {
            state.priceLabel = label || "‚Äî";
            if (tg?.MainButton) {
                const btnText = state.priceLabel === "‚Äî" ? "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å" : `–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å ¬∑ ${state.priceLabel}`;
                tg.MainButton.setText(btnText);
            }
        }

        function updatePrice() {
            const tokensPerSec = state.enableAudio ? state.tokensPerSecondAudio : state.tokensPerSecondStd;
            if (!Number.isFinite(tokensPerSec)) {
                setPriceLabel("‚Äî");
                return;
            }
            const total = tokensPerSec * state.duration;
            setPriceLabel(formatPrice(total));
        }

        function toggleAudio() {
            state.enableAudio = !state.enableAudio;
            els.audioToggle.classList.toggle("active", state.enableAudio);
            updatePrice();
        }

        function switchMode(mode) {
            state.generationType = mode;
            els.imageUploadSection.style.display = mode === "image2video" ? "block" : "none";
            els.formatSection.style.display = mode === "text2video" ? "block" : "none";
        }

        function sanitizeDuration(value) {
            const allowed = [5, 10];
            const num = Number(value);
            return allowed.includes(num) ? num : 5;
        }

        function sanitizeRatio(value) {
            const allowed = ["16:9", "9:16", "1:1"];
            return allowed.includes(value) ? value : "16:9";
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (async presigned upload)
        async function handleImageUpload(file) {
            const errorEl = els.startImageError;
            const boxEl = els.startImageBox;

            errorEl.textContent = "";

            if (!file) {
                resetImage();
                return;
            }

            if (!file.type.startsWith("image/")) {
                errorEl.textContent = "–ù—É–∂–µ–Ω JPG/PNG ‚â§ 10 –ú–ë.";
                resetImage();
                return;
            }

            if (file.size > MAX_IMAGE_SIZE) {
                errorEl.textContent = "–ù—É–∂–µ–Ω JPG/PNG ‚â§ 10 –ú–ë.";
                resetImage();
                return;
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–≥—Ä—É–∑–∫–∏
            boxEl.classList.add("has-file");
            boxEl.innerHTML = `
                <input type="file" accept="image/jpeg,image/png,image/webp">
                <div class="upload-icon">‚è≥</div>
                <div class="upload-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            `;

            state.imageUploading = true;
            state.imageMime = file.type;
            state.imageName = file.name;
            state.imageSize = file.size;

            try {
                console.log("[Kling v2-6 WebApp] Uploading image to Supabase...");
                const publicUrl = await uploadToSupabase(file);
                console.log("[Kling v2-6 WebApp] Upload complete:", publicUrl);

                // –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª –¥–ª—è –ø—Ä–µ–≤—å—é
                const reader = new FileReader();
                reader.onload = () => {
                    state.imageUrl = publicUrl;
                    state.imageUploading = false;
                    updateImageBoxUI(boxEl, file, reader.result);
                };
                reader.readAsDataURL(file);
            } catch (err) {
                console.error("[Kling v2-6 WebApp] Upload error:", err);
                errorEl.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.";
                resetImage();
            }
        }

        function resetImage() {
            state.imageUrl = null;
            state.imageSize = 0;
            state.imageMime = null;
            state.imageName = null;
            state.imageUploading = false;
            els.startImageInput.value = "";
            resetImageBoxUI(els.startImageBox);
        }

        function updateImageBoxUI(boxEl, file, dataUrl) {
            boxEl.classList.add("has-file");
            const sizeKb = (file.size / 1024).toFixed(1);
            boxEl.innerHTML = `
                <input type="file" accept="image/jpeg,image/png,image/webp">
                <img class="upload-preview" src="${dataUrl}" alt="preview">
                <div class="upload-file-info">
                    <span>${file.name} ¬∑ ${sizeKb} –ö–ë</span>
                    <span class="upload-remove">‚úï</span>
                </div>
            `;

            const newInput = boxEl.querySelector('input[type="file"]');
            const removeBtn = boxEl.querySelector('.upload-remove');

            newInput.addEventListener("change", (e) => {
                handleImageUpload(e.target.files?.[0]);
            });

            removeBtn.addEventListener("click", (e) => {
                e.stopPropagation();
                resetImage();
            });
        }

        function resetImageBoxUI(boxEl) {
            boxEl.classList.remove("has-file");
            boxEl.innerHTML = `
                <input type="file" id="startImageInput" accept="image/jpeg,image/png,image/webp">
                <div class="upload-icon">+</div>
                <div class="upload-text">–ó–∞–≥—Ä—É–∑–∏—Ç—å</div>
            `;

            els.startImageInput = document.getElementById("startImageInput");
            els.startImageInput.addEventListener("change", (e) => {
                handleImageUpload(e.target.files?.[0]);
            });
        }

        function sendData() {
            try {
                els.prompt.blur();
                if (!tg) {
                    setError("–û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ Telegram, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.");
                    return;
                }
                if (!state.prompt) {
                    tg.showAlert("–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º—Ç");
                    return;
                }
                if (state.generationType === "image2video" && !state.imageUrl) {
                    tg.showAlert("–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è —Ä–µ–∂–∏–º–∞ Image ‚Üí Video.");
                    return;
                }
                if (state.imageUploading) {
                    tg.showAlert("–î–æ–∂–¥–∏—Ç–µ—Å—å –æ–∫–æ–Ω—á–∞–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.");
                    return;
                }

                const payload = {
                    kind: "kling_settings",
                    modelSlug: state.modelSlug,
                    generationType: state.generationType,
                    prompt: state.prompt,
                    duration: state.duration,
                    enableAudio: state.enableAudio,
                };

                // –ü—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏ –∞—É–¥–∏–æ: mode = pro
                if (state.enableAudio) {
                    payload.mode = "pro";
                }

                if (state.generationType === "text2video") {
                    payload.aspectRatio = state.aspectRatio;
                }

                if (state.generationType === "image2video") {
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º URL –≤–º–µ—Å—Ç–æ base64
                    payload.imageUrl = state.imageUrl;
                    payload.imageSize = state.imageSize;
                    payload.imageMime = state.imageMime;
                    payload.imageName = state.imageName;
                }

                const userId = tg.initDataUnsafe?.user?.id;
                if (!userId) {
                    tg.showAlert("–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram.");
                    return;
                }

                try {
                    tg.MainButton.showProgress();
                } catch (_) { }

                console.log("[Kling v2-6 WebApp] Sending payload:", payload);

                // –¢–µ–ø–µ—Ä—å payload –º–∞–ª–µ–Ω—å–∫–∏–π - –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º keepalive
                fetch('/api/kling/webapp/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        data: payload,
                    }),
                    keepalive: true
                });

                // –°—Ä–∞–∑—É –∑–∞–∫—Ä—ã–≤–∞–µ–º webapp - –Ω–µ –∂–¥—ë–º –æ—Ç–≤–µ—Ç–∞
                console.log("[Kling v2-6 WebApp] Request sent, closing immediately...");
                tg.close();

            } catch (e) {
                if (tg) tg.showAlert("Critical Error: " + e.message);
            }
        }

        // Event listeners
        els.prompt.addEventListener("input", updateCounts);

        els.modeToggle.addEventListener("click", (e) => {
            const btn = e.target.closest(".chip");
            if (!btn) return;
            setActive(els.modeToggle, btn);
            switchMode(btn.dataset.mode);
        });

        els.audioToggle.addEventListener("click", toggleAudio);

        els.ratioGrid.addEventListener("click", (e) => {
            const btn = e.target.closest(".pill");
            if (!btn) return;
            setActive(els.ratioGrid, btn);
            state.aspectRatio = sanitizeRatio(btn.dataset.ratio);
        });

        els.durationToggle.addEventListener("click", (e) => {
            const btn = e.target.closest(".chip");
            if (!btn) return;
            setActive(els.durationToggle, btn);
            state.duration = sanitizeDuration(btn.dataset.duration);
            updatePrice();
        });

        els.startImageInput.addEventListener("change", (e) => {
            handleImageUpload(e.target.files?.[0]);
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ü–µ–Ω (—Ü–µ–Ω–∞ –∑–∞ 1 —Å–µ–∫—É–Ω–¥—É –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é)
        const pricePerSecFromQuery = params.get("price_per_sec");
        const priceAudioPerSecFromQuery = params.get("price_audio_per_sec");

        const tokensPerSecStd = parseTokens(pricePerSecFromQuery);
        const tokensPerSecAudio = parseTokens(priceAudioPerSecFromQuery);

        if (tokensPerSecStd !== null) {
            state.tokensPerSecondStd = tokensPerSecStd;

            if (tokensPerSecAudio !== null) {
                state.tokensPerSecondAudio = tokensPerSecAudio;
            } else {
                // Audio —Å—Ç–æ–∏—Ç –¥–æ—Ä–æ–∂–µ: 0.07 / 0.055
                state.tokensPerSecondAudio = state.tokensPerSecondStd * (PRICE_PER_SECOND_AUDIO / PRICE_PER_SECOND_STD);
            }
            updatePrice();
        } else {
            setPriceLabel("‚Äî");
        }

        updateCounts();
        switchMode("text2video");

        if (tg) {
            try {
                tg.ready();
                tg.expand();
                tg.onEvent("mainButtonClicked", sendData);
            } catch (e) {
                /* ignore */
            }
        } else {
            setError("–û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ Telegram, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.");
        }
    </script>
</body>

</html>
