<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Veo 3.1 Fast · INTEGER</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0f1c2d;
            --pane: #14263c;
            --pane-2: #1a324f;
            --text: #f2f4f8;
            --muted: #9fb4cc;
            --accent: #f19b28;
            --accent-2: #f6b24f;
            --danger: #ff6b6b;
            --border: #223956;
            --radius: 18px;
            --shadow: 0 12px 35px rgba(0, 0, 0, 0.35);
            --dot: radial-gradient(circle, rgba(255,255,255,0.06) 1px, transparent 0);
            --font: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            padding: 18px 16px 24px;
            font-family: var(--font);
            color: var(--text);
            background: var(--bg);
            background-image: var(--dot);
            background-size: 22px 22px;
        }

        .card {
            background: linear-gradient(145deg, var(--pane) 0%, #111c2f 60%, #0f1c2d 100%);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 16px 16px 10px;
            position: relative;
            overflow: hidden;
        }

        .card::after {
            content: "";
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 20% 20%, rgba(241,155,40,0.15), transparent 45%),
                        radial-gradient(circle at 80% 10%, rgba(246,178,79,0.08), transparent 35%);
            pointer-events: none;
        }

        .header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .badge {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
            color: #0f1c2d;
            font-weight: 800;
            font-size: 16px;
            display: grid;
            place-items: center;
            box-shadow: 0 10px 24px rgba(241,155,40,0.35);
        }

        h1 {
            font-size: 18px;
            font-weight: 800;
            margin: 0;
            letter-spacing: 0.1px;
        }

        .sub {
            font-size: 13px;
            color: var(--muted);
            margin: 0;
        }

        .section {
            background: rgba(20, 38, 60, 0.7);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 14px;
            margin: 12px 0;
        }

        .section-title {
            font-size: 14px;
            font-weight: 700;
            margin: 0 0 10px;
        }

        .chip-toggle {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .chip {
            background: #0f1c2d;
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 14px;
            padding: 12px;
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .chip.active {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
            color: #0f1c2d;
            box-shadow: 0 10px 24px rgba(241,155,40,0.35);
        }

        .label {
            font-size: 13px;
            color: var(--muted);
            margin: 10px 0 6px;
        }

        textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            background: #0d1a2b;
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text);
            font-size: 14px;
            resize: vertical;
            outline: none;
            transition: border-color 0.15s ease;
        }

        textarea:focus {
            border-color: var(--accent);
        }

        .count {
            font-size: 12px;
            color: var(--muted);
            text-align: right;
            margin-top: 4px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .pill {
            background: #0f1c2d;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 10px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
            color: var(--text);
            cursor: pointer;
            transition: all 0.12s ease;
        }

        .pill.active {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
            color: #0f1c2d;
            box-shadow: 0 8px 18px rgba(241,155,40,0.28);
        }

        .uploads {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 10px;
        }

        .upload-card {
            position: relative;
            border: 1px dashed var(--border);
            border-radius: 14px;
            padding: 12px;
            background: rgba(15, 28, 45, 0.7);
        }

        .upload-card strong {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
        }

        .upload-card small {
            color: var(--muted);
            font-size: 12px;
        }

        .upload-card input[type="file"] {
            margin-top: 10px;
            width: 100%;
            color: var(--muted);
        }

        .preview {
            margin-top: 10px;
            display: grid;
            grid-template-columns: 70px 1fr;
            gap: 10px;
            align-items: center;
        }

        .preview-thumb {
            width: 70px;
            height: 70px;
            border-radius: 10px;
            background: #0f1c2d;
            border: 1px solid var(--border);
            background-size: cover;
            background-position: center;
        }

        .preview-info {
            font-size: 13px;
            color: var(--muted);
            line-height: 1.35;
        }

        .error {
            color: var(--danger);
            font-size: 13px;
            margin-top: 8px;
        }

        .footer {
            position: sticky;
            bottom: 0;
            margin-top: 16px;
            background: linear-gradient(180deg, transparent, #0f1c2d 45%);
            padding-top: 12px;
        }

        .price-row {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 10px;
            background: rgba(20, 38, 60, 0.7);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
        }

        .price-label {
            font-size: 13px;
            color: var(--muted);
        }

        .price-value {
            font-size: 20px;
            font-weight: 800;
            color: var(--accent-2);
        }

        @media (min-width: 640px) {
            body { padding: 28px; }
            .card { max-width: 720px; margin: 0 auto; }
        }
    </style>
</head>
<body>
    <div class="card">
        <div class="header">
            <div class="badge">VEO</div>
            <div>
                <h1>Veo 3.1 Fast</h1>
                <p class="sub">WebApp · Генерация видео</p>
            </div>
        </div>

        <div class="section">
            <p class="section-title">Режим</p>
            <div class="chip-toggle" id="modeToggle">
                <div class="chip active" data-mode="text2video">Текст → Видео</div>
                <div class="chip" data-mode="image2video">Изображение → Видео</div>
            </div>

            <p class="label" style="margin-top: 12px;">Текстовый промт</p>
            <textarea id="prompt" placeholder="Опишите, что нужно сгенерировать..." maxlength="1000" enterkeyhint="done" inputmode="text"></textarea>
            <div class="count" id="promptCount">0/1000</div>
        </div>

        <div class="section">
            <p class="section-title">Соотношение сторон</p>
            <div class="grid" id="ratioGrid">
                <div class="pill active" data-ratio="9:16">9:16</div>
                <div class="pill" data-ratio="16:9">16:9</div>
                <div class="pill" data-ratio="1:1">1:1</div>
            </div>
        </div>

        <div class="section" id="uploadsSection" style="display:none;">
            <p class="section-title">Кадры для Image → Video</p>
            <div class="uploads">
                <div class="upload-card" id="startCard">
                    <strong>Начальный кадр (обязательно, ≤ 5 МБ)</strong>
                    <small>Загрузите изображение, с которого начнётся ролик.</small>
                    <input type="file" id="startInput" accept="image/*">
                    <div class="preview" id="startPreview" style="display:none;">
                        <div class="preview-thumb" id="startThumb"></div>
                        <div class="preview-info" id="startInfo"></div>
                    </div>
                </div>
                <div class="upload-card" id="endCard">
                    <strong>Конечный кадр (необязательно, ≤ 5 МБ)</strong>
                    <small>Добавьте, если хотите приблизить финальный кадр.</small>
                    <input type="file" id="endInput" accept="image/*">
                    <div class="preview" id="endPreview" style="display:none;">
                        <div class="preview-thumb" id="endThumb"></div>
                        <div class="preview-info" id="endInfo"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="error" class="error" style="display:none;"></div>

        <div class="footer">
            <div class="price-row">
                <div>
                    <div class="price-label">Стоимость</div>
                    <div class="price-label" style="margin-top:2px;">Фиксированная цена за генерацию</div>
                </div>
                <div class="price-value" id="priceValue">—</div>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram?.WebApp;
        const params = new URLSearchParams(window.location.search);
        const MAX_PROMPT = 1000;
        const MAX_BYTES = 5 * 1024 * 1024;

        const state = {
            modelSlug: params.get("model") || "veo3-fast",
            mode: "text2video",
            prompt: "",
            aspectRatio: "9:16",
            priceLabel: "—",
            start: { data: null, mime: null, name: null },
            end: { data: null, mime: null, name: null },
        };

        const els = {
            modeToggle: document.getElementById("modeToggle"),
            ratioGrid: document.getElementById("ratioGrid"),
            prompt: document.getElementById("prompt"),
            promptCount: document.getElementById("promptCount"),
            uploadsSection: document.getElementById("uploadsSection"),
            startInput: document.getElementById("startInput"),
            startPreview: document.getElementById("startPreview"),
            startThumb: document.getElementById("startThumb"),
            startInfo: document.getElementById("startInfo"),
            endInput: document.getElementById("endInput"),
            endPreview: document.getElementById("endPreview"),
            endThumb: document.getElementById("endThumb"),
            endInfo: document.getElementById("endInfo"),
            priceValue: document.getElementById("priceValue"),
            error: document.getElementById("error"),
        };

        function setActive(container, target) {
            container.querySelectorAll(".chip, .pill").forEach(btn => btn.classList.remove("active"));
            target.classList.add("active");
        }

        function showAlert(text) {
            if (!text) return;
            if (tg?.showAlert) {
                tg.showAlert(text);
            } else {
                alert(text);
            }
        }

        function updateCounts() {
            state.prompt = els.prompt.value.trim();
            els.promptCount.textContent = `${state.prompt.length}/${MAX_PROMPT}`;
            if (tg?.MainButton) {
                if (state.prompt.length > 0) {
                    tg.MainButton.show();
                } else {
                    tg.MainButton.hide();
                }
            }
        }

        function toggleUploads(show) {
            els.uploadsSection.style.display = show ? "block" : "none";
            if (!show) {
                state.start = { data: null, mime: null, name: null };
                state.end = { data: null, mime: null, name: null };
                els.startInput.value = "";
                els.endInput.value = "";
                els.startPreview.style.display = "none";
                els.endPreview.style.display = "none";
            }
        }

        function setPriceLabel(label) {
            state.priceLabel = label || "—";
            els.priceValue.textContent = state.priceLabel;
            if (tg?.MainButton) {
                const btnText = state.priceLabel === "—" ? "Сгенерировать" : `Сгенерировать · ${state.priceLabel}`;
                tg.MainButton.setText(btnText);
            }
        }

        function formatSize(bytes) {
            if (!bytes && bytes !== 0) return "";
            if (bytes > 1024 * 1024) return `${(bytes / (1024 * 1024)).toFixed(2)} МБ`;
            return `${(bytes / 1024).toFixed(1)} КБ`;
        }

        function handleFile(inputEl, target, previewEl, thumbEl, infoEl) {
            const file = inputEl.files?.[0];
            if (!file) {
                state[target] = { data: null, mime: null, name: null };
                previewEl.style.display = "none";
                return;
            }
            if (!file.type.startsWith("image/")) {
                showAlert("Нужен файл изображения.");
                inputEl.value = "";
                previewEl.style.display = "none";
                state[target] = { data: null, mime: null, name: null };
                return;
            }
            if (file.size > MAX_BYTES) {
                showAlert("Изображение слишком большое (макс 5 МБ).");
                inputEl.value = "";
                previewEl.style.display = "none";
                state[target] = { data: null, mime: null, name: null };
                return;
            }

            const reader = new FileReader();
            reader.onload = () => {
                const result = reader.result;
                if (typeof result === "string") {
                    const base64 = result.split(",")[1] || result;
                    state[target] = { data: base64, mime: file.type, name: file.name };
                    thumbEl.style.backgroundImage = `url(${result})`;
                    infoEl.textContent = `${file.name} · ${formatSize(file.size)}`;
                    previewEl.style.display = "grid";
                }
            };
            reader.onerror = () => {
                showAlert("Не удалось прочитать файл. Попробуйте выбрать другой.");
                inputEl.value = "";
                previewEl.style.display = "none";
                state[target] = { data: null, mime: null, name: null };
            };
            reader.readAsDataURL(file);
        }

        function buildPayload(prompt) {
            const paramsPayload = {
                aspectRatio: state.aspectRatio,
            };

            if (state.mode === "image2video") {
                paramsPayload.startImage = state.start.data;
                paramsPayload.startImageMime = state.start.mime;
                paramsPayload.startImageName = state.start.name;
                if (state.end.data) {
                    paramsPayload.endImage = state.end.data;
                    paramsPayload.endImageMime = state.end.mime;
                    paramsPayload.endImageName = state.end.name;
                }
            }

            return {
                kind: "veo_video_settings",
                modelSlug: state.modelSlug,
                mode: state.mode,
                prompt,
                params: paramsPayload,
            };
        }

        function sendData() {
            els.prompt.blur();
            const prompt = (state.prompt || "").trim();
            if (!prompt) {
                showAlert("Введите промт, чтобы продолжить.");
                return;
            }
            if (prompt.length > MAX_PROMPT) {
                showAlert(`Промт слишком длинный (> ${MAX_PROMPT} символов).`);
                return;
            }
            if (state.mode === "image2video" && !state.start.data) {
                showAlert("Загрузите начальный кадр (до 5 МБ).");
                return;
            }

            const payload = buildPayload(prompt);
            const userId = tg?.initDataUnsafe?.user?.id;

            if (!userId) {
                showAlert("Ошибка: не удалось определить пользователя Telegram.");
                return;
            }

            try {
                if (tg) {
                    tg.MainButton?.showProgress();
                    fetch("/api/veo/webapp/submit", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            user_id: userId,
                            data: payload,
                            initData: tg.initData || "",
                        }),
                    })
                        .then((res) => {
                            if (res.ok) {
                                tg.close();
                            } else {
                                tg.MainButton?.hideProgress();
                                showAlert("Ошибка сервера. Попробуйте позже.");
                            }
                        })
                        .catch((e) => {
                            tg.MainButton?.hideProgress();
                            console.error("[Veo WebApp] REST error:", e);
                            showAlert("Ошибка сети: " + e.message);
                        });
                } else {
                    showAlert("Откройте страницу через Telegram, чтобы отправить настройки.");
                }
            } catch (e) {
                console.error("[Veo WebApp] Exception:", e);
                showAlert("Не удалось отправить данные. Попробуйте ещё раз.");
            }
        }

        els.prompt.addEventListener("input", updateCounts);

        els.modeToggle.addEventListener("click", (e) => {
            const btn = e.target.closest(".chip");
            if (!btn) return;
            setActive(els.modeToggle, btn);
            state.mode = btn.dataset.mode;
            toggleUploads(state.mode === "image2video");
        });

        els.ratioGrid.addEventListener("click", (e) => {
            const btn = e.target.closest(".pill");
            if (!btn) return;
            setActive(els.ratioGrid, btn);
            state.aspectRatio = btn.dataset.ratio;
        });

        els.startInput.addEventListener("change", () =>
            handleFile(els.startInput, "start", els.startPreview, els.startThumb, els.startInfo)
        );
        els.endInput.addEventListener("change", () =>
            handleFile(els.endInput, "end", els.endPreview, els.endThumb, els.endInfo)
        );

        const priceFromQuery = params.get("price");
        if (priceFromQuery) {
            setPriceLabel(priceFromQuery);
        }
        try {
            const init = tg?.initDataUnsafe?.start_param;
            if (init && init.startsWith("price=")) {
                const price = init.replace("price=", "");
                setPriceLabel(price);
            }
        } catch (e) {
            /* ignore */
        }
        if (state.priceLabel === "—" && !priceFromQuery) {
            setPriceLabel("—");
        }

        updateCounts();
        toggleUploads(false);

        if (tg) {
            try {
                tg.ready();
                tg.expand();
                tg.onEvent("mainButtonClicked", sendData);
            } catch (e) {
                /* ignore */
            }
        } else {
            showAlert("Откройте страницу через Telegram, чтобы отправить настройки.");
        }
    </script>
</body>
</html>
