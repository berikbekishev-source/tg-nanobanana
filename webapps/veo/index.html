<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Veo 3.1 Fast · INTEGER</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        // Global error handler for client-side debugging
        window.onerror = function (msg, url, line, col, error) {
            const tg = window.Telegram?.WebApp;
            if (tg) {
                tg.showAlert(`JS Error: ${msg}\nLine: ${line}`);
            }
            return false;
        };
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0f1c2d;
            --pane: #14263c;
            --pane-2: #1a324f;
            --text: #f2f4f8;
            --muted: #9fb4cc;
            --accent: #f19b28;
            --accent-2: #f6b24f;
            --danger: #ff6b6b;
            --border: #223956;
            --radius: 18px;
            --shadow: 0 12px 35px rgba(0, 0, 0, 0.35);
            --dot: radial-gradient(circle, rgba(255, 255, 255, 0.06) 1px, transparent 0);
            --font: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 18px 16px 24px;
            font-family: var(--font);
            color: var(--text);
            background: var(--bg);
            background-image: var(--dot);
            background-size: 22px 22px;
        }

        .card {
            background: linear-gradient(145deg, var(--pane) 0%, #111c2f 60%, #0f1c2d 100%);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 16px 16px 10px;
            position: relative;
            overflow: hidden;
        }

        .card::after {
            content: "";
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 20% 20%, rgba(241, 155, 40, 0.15), transparent 45%),
                radial-gradient(circle at 80% 10%, rgba(246, 178, 79, 0.08), transparent 35%);
            pointer-events: none;
        }

        .header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .badge {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
            color: #0f1c2d;
            font-weight: 800;
            font-size: 16px;
            display: grid;
            place-items: center;
            box-shadow: 0 10px 24px rgba(241, 155, 40, 0.35);
        }

        h1 {
            font-size: 18px;
            font-weight: 800;
            margin: 0;
            letter-spacing: 0.1px;
        }

        .sub {
            font-size: 13px;
            color: var(--muted);
            margin: 0;
        }

        .section {
            background: rgba(20, 38, 60, 0.7);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 14px;
            margin: 12px 0;
        }

        .section-title {
            font-size: 14px;
            font-weight: 700;
            margin: 0 0 10px;
        }

        .chip-toggle {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .chip {
            background: #0f1c2d;
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 14px;
            padding: 12px;
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .chip.active {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
            color: #0f1c2d;
            box-shadow: 0 10px 24px rgba(241, 155, 40, 0.35);
        }

        .label {
            font-size: 13px;
            color: var(--muted);
            margin: 10px 0 6px;
        }

        textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            background: #0d1a2b;
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text);
            font-size: 14px;
            resize: vertical;
            outline: none;
            transition: border-color 0.15s ease;
        }

        textarea:focus {
            border-color: var(--accent);
        }

        .count {
            font-size: 12px;
            color: var(--muted);
            text-align: right;
            margin-top: 4px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .pill {
            background: #0f1c2d;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 10px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
            color: var(--text);
            cursor: pointer;
            transition: all 0.12s ease;
        }

        .pill.active {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
            color: #0f1c2d;
            box-shadow: 0 8px 18px rgba(241, 155, 40, 0.28);
        }

        .uploads {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 10px;
        }

        .upload-card {
            position: relative;
            border: 1px dashed var(--border);
            border-radius: 14px;
            padding: 12px;
            background: rgba(15, 28, 45, 0.7);
        }

        .upload-card strong {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
        }

        .upload-card small {
            color: var(--muted);
            font-size: 12px;
        }

        .upload-card input[type="file"] {
            margin-top: 10px;
            width: 100%;
            color: var(--muted);
        }

        .preview {
            margin-top: 10px;
            display: grid;
            grid-template-columns: 70px 1fr;
            gap: 10px;
            align-items: center;
        }

        .preview-thumb {
            width: 70px;
            height: 70px;
            border-radius: 10px;
            background: #0f1c2d;
            border: 1px solid var(--border);
            background-size: cover;
            background-position: center;
        }

        .preview-info {
            font-size: 13px;
            color: var(--muted);
            line-height: 1.35;
        }

        .error {
            color: var(--danger);
            font-size: 13px;
            margin-top: 8px;
        }

        @media (min-width: 640px) {
            body {
                padding: 28px;
            }

            .card {
                max-width: 720px;
                margin: 0 auto;
            }
        }
    </style>
</head>

<body>
    <div class="card">
        <div class="header">
            <div class="badge">VEO</div>
            <div>
                <h1>Veo 3.1 Fast</h1>
                <p class="sub">WebApp · Генерация видео</p>
            </div>
        </div>

        <div class="section">
            <p class="section-title">Режим</p>
            <div class="chip-toggle" id="modeToggle">
                <div class="chip active" data-mode="text2video">Текст → Видео</div>
                <div class="chip" data-mode="image2video">Изображение → Видео</div>
            </div>

            <p class="label" style="margin-top: 12px;">Текстовый промт</p>
            <textarea id="prompt" placeholder="Опишите, что нужно сгенерировать..." maxlength="4000" enterkeyhint="done"
                inputmode="text"></textarea>
            <div class="count" id="promptCount">0/4000</div>
        </div>

        <div class="section" id="uploadsSection" style="display:none;">
            <p class="section-title">Кадры для Image → Video</p>
            <div class="uploads">
                <div class="upload-card" id="startCard">
                    <strong>Начальный кадр (обязательно, ≤ 5 МБ)</strong>
                    <small>Загрузите изображение, с которого начнётся ролик.</small>
                    <input type="file" id="startInput" accept="image/*">
                    <div class="preview" id="startPreview" style="display:none;">
                        <div class="preview-thumb" id="startThumb"></div>
                        <div class="preview-info" id="startInfo"></div>
                    </div>
                </div>
                <div class="upload-card" id="endCard">
                    <strong>Конечный кадр (необязательно, ≤ 5 МБ)</strong>
                    <small>Добавьте, если хотите приблизить финальный кадр.</small>
                    <input type="file" id="endInput" accept="image/*">
                    <div class="preview" id="endPreview" style="display:none;">
                        <div class="preview-thumb" id="endThumb"></div>
                        <div class="preview-info" id="endInfo"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <p class="section-title">Разрешение</p>
            <div class="grid" id="resolutionGrid">
                <div class="pill active" data-resolution="720p">720p</div>
            </div>
        </div>

        <div class="section">
            <p class="section-title">Соотношение сторон</p>
            <div class="grid" id="ratioGrid">
                <div class="pill active" data-ratio="9:16">9:16</div>
                <div class="pill" data-ratio="16:9">16:9</div>
            </div>
            <p class="label" style="margin-top: 12px;">Длительность видео по умолчанию 8 секунд.</p>
        </div>

        <div id="error" class="error" style="display:none;"></div>
    </div>

    <script>
        const tg = window.Telegram?.WebApp;
        const params = new URLSearchParams(window.location.search);
        const MAX_PROMPT = Number(params.get("max_prompt") || params.get("maxPrompt")) || 4000;
        const MAX_BYTES = 5 * 1024 * 1024;

        const state = {
            modelSlug: params.get("model") || "veo3-fast",
            mode: "text2video",
            prompt: "",
            aspectRatio: "9:16",
            resolution: "720p",
            // Изображения хранят URL после presigned upload
            start: { url: null, size: 0, mime: null, name: null, uploading: false },
            end: { url: null, size: 0, mime: null, name: null, uploading: false },
            priceLabel: "—",
            tokensPerSecond: null,
            priceBaseDuration: 8,
        };

        // Загрузка изображения через presigned URL в Supabase
        async function uploadToSupabase(file) {
            const resp = await fetch('/api/storage/presigned-upload', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content_type: file.type })
            });
            if (!resp.ok) throw new Error('Не удалось получить URL');
            const { upload_url, public_url } = await resp.json();
            const upload = await fetch(upload_url, {
                method: 'PUT',
                headers: { 'Content-Type': file.type },
                body: file
            });
            if (!upload.ok) throw new Error('Не удалось загрузить');
            return public_url;
        }

        const els = {
            modeToggle: document.getElementById("modeToggle"),
            ratioGrid: document.getElementById("ratioGrid"),
            resolutionGrid: document.getElementById("resolutionGrid"),
            prompt: document.getElementById("prompt"),
            promptCount: document.getElementById("promptCount"),
            uploadsSection: document.getElementById("uploadsSection"),
            startInput: document.getElementById("startInput"),
            startPreview: document.getElementById("startPreview"),
            startThumb: document.getElementById("startThumb"),
            startInfo: document.getElementById("startInfo"),
            endInput: document.getElementById("endInput"),
            endPreview: document.getElementById("endPreview"),
            endThumb: document.getElementById("endThumb"),
            endInfo: document.getElementById("endInfo"),
            error: document.getElementById("error"),
        };

        function setActive(container, target) {
            container.querySelectorAll(".chip, .pill").forEach(btn => btn.classList.remove("active"));
            target.classList.add("active");
        }

        function applyResolutionRules() {
            // В текущей версии доступно только 720p
            state.resolution = "720p";
            const active = els.resolutionGrid?.querySelector('.pill[data-resolution=\"720p\"]');
            if (active) setActive(els.resolutionGrid, active);
        }

        // Применяем динамический лимит промта из параметров, если указан
        const effectiveMaxPrompt = Number.isFinite(MAX_PROMPT) ? MAX_PROMPT : 4000;
        if (els.prompt) {
            els.prompt.setAttribute("maxlength", effectiveMaxPrompt);
            els.promptCount.textContent = `0/${Number.isFinite(MAX_PROMPT) ? MAX_PROMPT : "∞"}`;
        }

        function showAlert(text) {
            if (!text) return;
            if (tg?.showAlert) {
                tg.showAlert(text);
            } else {
                alert(text);
            }
        }

        function parseTokens(label) {
            if (!label) return null;
            const match = String(label).replace(",", ".").match(/([0-9]+(?:\.[0-9]+)?)/);
            if (!match) return null;
            const value = Number(match[1]);
            return Number.isFinite(value) ? value : null;
        }

        function formatPrice(tokens) {
            if (!Number.isFinite(tokens)) return "—";
            return `⚡${tokens.toFixed(2)} токенов`;
        }

        function setPriceLabel(label) {
            state.priceLabel = label || "—";
            if (tg?.MainButton) {
                const btnText = state.priceLabel === "—" ? "Сгенерировать" : `Сгенерировать · ${state.priceLabel}`;
                tg.MainButton.setText(btnText);
            }
        }

        function updateCounts() {
            state.prompt = els.prompt.value.trim();
            els.promptCount.textContent = `${state.prompt.length}/${Number.isFinite(MAX_PROMPT) ? MAX_PROMPT : "∞"}`;
            if (tg?.MainButton) {
                if (state.prompt.length > 0) {
                    setPriceLabel(state.priceLabel || "—");
                    tg.MainButton.show();
                } else {
                    tg.MainButton.hide();
                }
            }
        }

        function toggleUploads(show) {
            els.uploadsSection.style.display = show ? "block" : "none";
            if (!show) {
                state.start = { url: null, size: 0, mime: null, name: null, uploading: false };
                state.end = { url: null, size: 0, mime: null, name: null, uploading: false };
                els.startInput.value = "";
                els.endInput.value = "";
                els.startPreview.style.display = "none";
                els.endPreview.style.display = "none";
            }
        }

        function formatSize(bytes) {
            if (!bytes && bytes !== 0) return "";
            if (bytes > 1024 * 1024) return `${(bytes / (1024 * 1024)).toFixed(2)} МБ`;
            return `${(bytes / 1024).toFixed(1)} КБ`;
        }

        async function handleFile(inputEl, target, previewEl, thumbEl, infoEl) {
            const file = inputEl.files?.[0];
            if (!file) {
                state[target] = { url: null, size: 0, mime: null, name: null, uploading: false };
                previewEl.style.display = "none";
                return;
            }
            if (!file.type.startsWith("image/")) {
                showAlert("Нужен файл изображения.");
                inputEl.value = "";
                previewEl.style.display = "none";
                state[target] = { url: null, size: 0, mime: null, name: null, uploading: false };
                return;
            }
            if (file.size > MAX_BYTES) {
                showAlert("Изображение слишком большое (макс 5 МБ).");
                inputEl.value = "";
                previewEl.style.display = "none";
                state[target] = { url: null, size: 0, mime: null, name: null, uploading: false };
                return;
            }

            // Показываем превью сразу
            const reader = new FileReader();
            reader.onload = () => {
                thumbEl.style.backgroundImage = `url(${reader.result})`;
                infoEl.textContent = "Загрузка...";
                previewEl.style.display = "grid";
            };
            reader.readAsDataURL(file);

            state[target] = { url: null, size: file.size, mime: file.type, name: file.name, uploading: true };

            try {
                console.log(`[Veo WebApp] Uploading ${target} image...`);
                const publicUrl = await uploadToSupabase(file);
                console.log(`[Veo WebApp] Upload complete: ${publicUrl}`);
                state[target] = { url: publicUrl, size: file.size, mime: file.type, name: file.name, uploading: false };
                infoEl.textContent = `${file.name} · ${formatSize(file.size)}`;
            } catch (error) {
                console.error(`[Veo WebApp] Upload error:`, error);
                showAlert("Ошибка загрузки. Попробуйте ещё раз.");
                inputEl.value = "";
                previewEl.style.display = "none";
                state[target] = { url: null, size: 0, mime: null, name: null, uploading: false };
            }
        }

        function buildPayload(prompt) {
            const payload = {
                kind: "veo_video_settings",
                modelSlug: state.modelSlug,
                generationType: state.mode, // backend ожидает generationType
                prompt,
                aspectRatio: state.aspectRatio,
                resolution: state.resolution,
            };

            if (state.mode === "image2video") {
                // Отправляем URL вместо base64
                payload.imageUrl = state.start.url;
                payload.imageSize = state.start.size;
                payload.imageMime = state.start.mime;
                payload.imageName = state.start.name;

                if (state.end.url) {
                    payload.imageTailUrl = state.end.url;
                    payload.imageTailSize = state.end.size;
                    payload.imageTailMime = state.end.mime;
                    payload.imageTailName = state.end.name;
                }
            }

            return payload;
        }

        function sendData() {
            try {
                els.prompt.blur();
                const prompt = (state.prompt || "").trim();
                if (!prompt) {
                    showAlert("Введите промт, чтобы продолжить.");
                    return;
                }
                if (prompt.length > MAX_PROMPT) {
                    showAlert(`Промт слишком длинный (> ${MAX_PROMPT} символов).`);
                    return;
                }

                // Проверка изображения для image2video
                if (state.mode === "image2video") {
                    if (!state.start.url) {
                        showAlert("Загрузите начальный кадр (до 5 МБ).");
                        return;
                    }
                    if (state.start.uploading || state.end.uploading) {
                        showAlert("Дождитесь окончания загрузки изображения.");
                        return;
                    }
                }

                const payload = buildPayload(prompt);
                const userId = tg?.initDataUnsafe?.user?.id;

                if (!userId) {
                    showAlert("Ошибка: не удалось определить пользователя Telegram.");
                    return;
                }

                if (!tg) {
                    showAlert("Откройте страницу через Telegram, чтобы отправить настройки.");
                    return;
                }

                console.log("[Veo WebApp] Sending payload:", JSON.stringify(payload));
                tg.MainButton?.showProgress();

                // Теперь payload маленький - всегда используем keepalive
                fetch("/api/veo/webapp/submit", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        user_id: userId,
                        data: payload,
                        initData: tg.initData || "",
                    }),
                    keepalive: true
                });

                // Сразу закрываем webapp - не ждём ответа
                console.log("[Veo WebApp] Request sent, closing immediately...");
                tg.close();

            } catch (e) {
                console.error("[Veo WebApp] Exception:", e);
                if (tg) {
                    tg.MainButton?.hideProgress();
                    showAlert("Критическая ошибка: " + e.message);
                } else {
                    showAlert("Не удалось отправить данные. Попробуйте ещё раз.");
                }
            }
        }

        els.prompt.addEventListener("input", updateCounts);

        els.modeToggle.addEventListener("click", (e) => {
            const btn = e.target.closest(".chip");
            if (!btn) return;
            setActive(els.modeToggle, btn);
            state.mode = btn.dataset.mode;
            toggleUploads(state.mode === "image2video");
        });

        els.ratioGrid.addEventListener("click", (e) => {
            const btn = e.target.closest(".pill");
            if (!btn) return;
            setActive(els.ratioGrid, btn);
            state.aspectRatio = btn.dataset.ratio;
            applyResolutionRules();
        });

        els.resolutionGrid.addEventListener("click", (e) => {
            const btn = e.target.closest(".pill");
            if (!btn) return;
            setActive(els.resolutionGrid, btn);
            state.resolution = btn.dataset.resolution;
        });

        els.startInput.addEventListener("change", () =>
            handleFile(els.startInput, "start", els.startPreview, els.startThumb, els.startInfo)
        );
        els.endInput.addEventListener("change", () =>
            handleFile(els.endInput, "end", els.endPreview, els.endThumb, els.endInfo)
        );

        const priceFromQuery = params.get("price");
        const startParamRaw = tg?.initDataUnsafe?.start_param;
        let rawPrice = priceFromQuery;
        if (!rawPrice && startParamRaw && startParamRaw.startsWith("price=")) {
            rawPrice = startParamRaw.replace("price=", "");
        }
        const baseTokens = parseTokens(rawPrice);
        if (baseTokens !== null) {
            state.priceBaseDuration = state.priceBaseDuration || 8;
            state.tokensPerSecond = baseTokens / state.priceBaseDuration;
            setPriceLabel(formatPrice(baseTokens));
        } else {
            setPriceLabel("—");
        }

        applyResolutionRules();
        updateCounts();
        toggleUploads(false);

        if (tg) {
            try {
                tg.ready();
                tg.expand();
                tg.onEvent("mainButtonClicked", sendData);
            } catch (e) {
                /* ignore */
            }
        } else {
            showAlert("Откройте страницу через Telegram, чтобы отправить настройки.");
        }
    </script>
</body>

</html>
